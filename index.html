<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Union Dispensary Interactive Menu</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Lora:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // === Custom Tailwind Configuration for Branding ===
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cream: '#F8F2E2',     // Light background
                        sage: '#808A6F',      // Accent and detail
                        forest: '#22352F',    // Dark text and primary elements
                        red_sale: '#EF4444',  // Red color for sold out/featured status
                        orange_low: '#F59E0B', // Orange for low stock
                        sale_blue: '#3B82F6', // Blue for Sale status
                    },
                    fontFamily: {
                        script: ['Great Vibes', 'cursive'], // Script font for main title
                        serif: ['Lora', 'serif'],         // Serif font for body text
                        sans: ['Inter', 'sans-serif'],    // Fallback sans
                    },
                }
            }
        }
    </script>
    <style>
        /* Global Styles */
        body {
            font-family: 'Lora', serif;
            background-color: #808A6F; /* Sage Background */
            color: #22352F; /* Forest Text */
        }
        /* Fix for scrollable categories bar */
        .categories-container::-webkit-scrollbar {
            display: none;
        }
        .categories-container {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        /* Custom styles for aesthetic buttons */
        .btn-brand {
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn-brand:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Style for required form fields */
        label.required::after {
            content: " *";
            color: #ef4444; /* Red-600 */
        }
        /* Class for sold-out items (Customer View) */
        .sold-out {
            /* Dim the entire card to show it's inactive/out */
            opacity: 0.55; 
            filter: grayscale(80%);
            position: relative;
        }
        /* Ensure click is only blocked in customer mode */
        body:not(.admin-mode) .sold-out {
             pointer-events: none;
        }
        
        /* Animation for settings icon in admin mode */
        .rotate-90 {
            transform: rotate(90deg);
        }

        /* Line clamp for description */
        .line-clamp-2 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
        }
        /* Mobile optimization: smaller padding on tabs for smaller screens */
        @media (max-width: 640px) {
            #category-tabs button {
                padding: 0.75rem 0.5rem; /* Reduced horizontal padding */
                font-size: 0.875rem; /* text-sm */
            }
            .categories-container svg {
                width: 1.1rem;
                height: 1.1rem;
            }
            .modal-content-area {
                max-height: 80vh; /* Allow more space for mobile modal content */
                overflow-y: auto;
            }
        }

    </style>
</head>
<body class="bg-sage min-h-screen">

    <div id="app" class="max-w-7xl mx-auto bg-cream shadow-2xl min-h-screen">

        <header class="sticky top-0 z-30 shadow-lg bg-forest">
            <div class="p-4 flex justify-between items-center text-cream">
                
                <h1 class="text-3xl md:text-4xl font-script text-cream">Union Dispensary</h1>
                
                <button id="edit-toggle-btn" class="bg-sage text-cream p-3 rounded-full btn-brand hover:bg-sage/80" onclick="toggleEditMode()" title="Toggle Edit Mode">
                    <svg id="settings-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 transition-transform duration-300">
                        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.78 1.35a2 2 0 0 0 .72 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15-.09a2 2 0 0 0-.73 2.73l.78 1.35a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73v.18a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.78-1.35a2 2 0 0 0-.72-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l-.15-.09a2 2 0 0 0 .73-2.73l-.78-1.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                </button>
            </div>

            <div id="category-tabs" class="categories-container flex overflow-x-auto border-t border-b border-cream/20 bg-forest/90 sticky top-[68px] md:top-[76px] z-20">
                </div>
        </header>

        <main class="p-4 md:p-6">
            
            <div id="controls-container" class="bg-cream pt-2 pb-4 z-10">
                </div>

            <div id="add-item-container" class="mb-6 hidden">
                </div>

            <div class="text-center text-xl text-sage pt-10" id="loading-indicator">Loading menu data...</div>

            <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6 pt-4">
                </div>
        </main>
    </div>

    <div id="pin-modal" class="hidden fixed inset-0 bg-forest bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-cream p-8 rounded-xl shadow-2xl w-full max-w-sm text-forest">
            <h3 class="text-2xl font-bold mb-4 font-serif">Enter Admin Key</h3>
            <p id="pin-error" class="text-sm mb-4 text-red_sale font-medium"></p>
            
            <input type="password" id="admin-pin-input" onkeydown="handlePinKeydown(event)" class="w-full p-3 mb-4 border-2 border-sage rounded-lg bg-white text-forest placeholder-sage/70 focus:outline-none focus:ring-2 focus:ring-sage font-serif" placeholder="Key: union420">
            <div class="flex justify-between space-x-3">
                <button class="flex-1 bg-gray-300 text-forest p-3 rounded-lg hover:bg-gray-400 transition" onclick="toggleEditMode(false)">Cancel</button>
                <button class="flex-1 bg-forest text-cream p-3 rounded-lg font-bold hover:bg-sage transition" onclick="checkAdminKey()">Unlock Editor</button>
            </div>
        </div>
    </div>

    <div id="crud-modal" class="hidden fixed inset-0 bg-forest bg-opacity-75 flex items-center justify-center z-40 overflow-y-auto p-4">
        <div class="bg-cream p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-xl text-forest my-8 font-serif">
            <h3 id="crud-modal-title" class="text-3xl font-bold mb-6 border-b pb-3 border-sage/50"></h3>
            
            <form id="crud-form">
                <div id="crud-fields-container" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                    </div>
                <div class="flex justify-end space-x-3 mt-8 pt-4 border-t border-sage/50">
                    <button type="button" class="bg-gray-300 text-forest p-3 rounded-lg hover:bg-gray-400 transition btn-brand" onclick="hideCrudModal()">Cancel</button>
                    <button type="submit" id="crud-save-btn" class="bg-forest text-cream p-3 rounded-lg font-bold hover:bg-sage transition btn-brand">Save Item</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="delete-modal" class="hidden fixed inset-0 bg-forest bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-cream p-8 rounded-xl shadow-2xl w-full max-w-md text-forest">
            <h3 class="text-2xl font-bold mb-4 font-serif">Confirm Deletion</h3>
            <p class="mb-6 font-serif">Are you sure you want to delete <span id="delete-item-name" class="font-bold text-red_sale"></span>? This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button class="bg-gray-300 text-forest p-3 rounded-lg hover:bg-gray-400 transition" onclick="hideDeleteModal()">Cancel</button>
                <button class="bg-red_sale text-white p-3 rounded-lg font-bold hover:bg-red-700 transition btn-brand" onclick="executeDelete()">Delete Permanently</button>
            </div>
        </div>
    </div>

    <div id="category-selection-modal" class="hidden fixed inset-0 bg-forest bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-cream p-8 rounded-xl shadow-2xl w-full max-w-sm text-forest">
            <h3 class="text-2xl font-bold mb-4 font-serif">Select Product Category</h3>
            <p class="mb-6 text-sage font-serif">Which type of product are you adding?</p>
            <div id="category-buttons-container" class="grid grid-cols-2 gap-3">
                </div>
            <div class="mt-6 flex justify-end">
                <button class="bg-gray-300 text-forest p-3 rounded-lg hover:bg-gray-400 transition" onclick="hideCategorySelectionModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="item-detail-modal" class="hidden fixed inset-0 bg-forest bg-opacity-75 flex items-center justify-center z-40 overflow-y-auto p-4">
        <div class="bg-cream p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-lg text-forest my-8 font-serif">
            <h3 id="detail-modal-title" class="text-3xl font-bold mb-4 border-b pb-2 border-sage/50"></h3>
            <div id="detail-modal-body" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                </div>
            <div class="mt-8 flex justify-end">
                <button class="bg-sage text-cream p-3 rounded-lg font-bold hover:bg-forest transition btn-brand" onclick="hideItemDetailModal()">Close</button>
            </div>
        </div>
    </div>
    
    <div id="message-box" class="hidden fixed top-24 right-4 bg-forest text-cream p-4 rounded-lg shadow-xl opacity-0 transition-all duration-300 z-50 font-serif min-w-[200px]"></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, query, where, getDocs, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // setLogLevel('Debug'); // Uncomment this line to enable verbose Firebase logging

        // Global Firebase References (available to the window object)
        window.db = null;
        window.auth = null;
        window.userId = null;
        // Expose Firebase functions globally for use in the main script block
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.onSnapshot = onSnapshot;
        window.doc = doc;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;
        window.updateDoc = updateDoc;
        window.writeBatch = writeBatch;
        
        // Initialization Logic
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        if (Object.keys(firebaseConfig).length > 0) {
            try {
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
            }
        }
        
        // Authentication Function
        async function authenticate() {
            try {
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await window.signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await window.signInAnonymously(window.auth);
                }
                window.userId = window.auth.currentUser.uid;
                window.initMenu(); 
            } catch (error) {
                console.error("Firebase Auth error:", error);
                if(window.showMessage) {
                    window.showMessage("Could not authenticate with database.", true); 
                }
            }
        }
        
        // Start the application
        document.addEventListener('DOMContentLoaded', () => {
             if (window.db) {
                authenticate();
             } else {
                console.warn("Firebase not initialized, running in mock mode.");
                window.initMenu(true); // Run mock mode
             }
        });

    </script>
    
    <script>
        // === App State and Configuration ===
        
        let inventory = {}; 
        let currentCategory = 'Flower';
        let isEditMode = false;
        let currentItemForEdit = null; 
        let deleteItemDetails = null;
        let currentSearchQuery = '';
        let currentTypeFilter = 'All'; 
        let currentSortBy = 'name'; 
        let currentSortDirection = 'asc'; 
        let currentFormatFilter = 'All'; 
        let currentDeviceFilter = 'All'; 
        let currentVolumeFilter = 'All';
        let currentRatioFilter = 'All'; 
        let currentPackagingFilter = 'All'; 
        let currentInfusionFilter = 'All'; 
        let currentFormFilter = 'All'; 
        let currentWeightFilter = 'All'; 
        let currentCannabinoidFilter = 'All'; 

        
        // Icon mapping for categories (using elegant, simple SVGs)
        const categoryIcons = {
            'Flower': `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20"/><path d="M17 5H7"/><path d="M17 19H7"/><path d="M19 12c0 3.866-3.134 7-7 7s-7-3.134-7-7c0-3.866 3.134-7 7-7s7 3.134 7 7z"/></svg>`, 
            'Concentrates': `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 11V7a4 4 0 0 0-8 0v4"/><path d="M22 11h-2a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2v-8z"/><path d="M2 11h2a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H2v-8z"/><path d="M10 21h4"/></svg>`,
            'Cartridges': `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 11V7a4 4 0 0 0-8 0v4"/><path d="M12 21a2 2 0 0 0 2-2v-8a2 2 0 0 0-4 0v8a2 2 0 0 0 2 2z"/></svg>`,
            'Edibles': `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2z"/><path d="M16.2 7.8c-1-1-2.2-1.8-3.6-2.2-1.4-.4-2.8-.2-4.2.6-1.4.8-2.6 2-3.4 3.4-.8 1.4-1 3-1 4.6 0 1.6.4 3.2 1.2 4.6.8 1.4 2 2.6 3.4 3.4 1.4.8 3 .8 4.6.8s3.2-.4 4.6-1.2c1.4-.8 2.6-2 3.4-3.4.8-1.4 1.2-3 1.2-4.6 0-1.6-.4-3.2-1.2-4.6-.8-1.4-2-2.6-3.4-3.4z"/><path d="M12 18c-3.3 0-6-2.7-6-6s2.7-6 6-6 6 2.7 6 6-2.7 6-6 6z"/></svg>`,
            'Topicals': `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22a7 7 0 0 0-7-7h14a7 7 0 0 0-7 7z"/><path d="M12 15V3.5A1.5 1.5 0 0 1 13.5 2h0A1.5 1.5 0 0 1 15 3.5v3.5"/><path d="M12 15V3.5A1.5 1.5 0 0 0 10.5 2h0A1.5 1.5 0 0 0 9 3.5v3.5"/></svg>`,
            'Tinctures': `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 16V9a3 3 0 0 1 6 0v7"/><path d="M10 22h4"/><path d="M10 16a3 3 0 0 1-6 0h12a3 3 0 0 1-6 0z"/><path d="M10 16h4"/></svg>`,
            'Pre-Rolls': `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6H6a4 4 0 0 0-4 4v4a4 4 0 0 0 4 4h12a4 4 0 0 0 4-4v-4a4 4 0 0 0-4-4z"/><path d="M2 10h4"/><path d="M22 10h-4"/><path d="M2 14h4"/><path d="M22 14h-4"/></svg>`,
            'Specials': `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19.5 12.5c0 1.1-.9 2-2 2s-2-.9-2-2.9.9-2 2-2c1.1 0 2 .9 2 2.9z"/><path d="M17.5 14.5c0 1.1.9 2 2 2s2-.9 2-2.9-.9-2-2-2c-1.1 0-2 .9-2 2.9z"/><path d="M12.5 19.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/><path d="M14.5 17.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/><path d="M7 12a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/><path d="M14 10.042A6.14 6.14 0 0 0 12.503 10a6.16 6.16 0 0 0-1.498.042"/><path d="M9.958 14A6.14 6.14 0 0 0 10 12.503a6.16 6.16 0 0 0-.042-1.498"/><path d="M17 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></svg>`,
            'All Products': `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 15h1.5a2.5 2.5 0 0 1 0 5H4"/><path d="M19.5 15H18a2.5 2.5 0 0 1 0 5h1.5"/><line x1="12" y1="9" x2="12" y2="15"/><line x1="9" y1="12" x2="15" y2="12"/></svg>`
        };

        // Definitive structure for each category's data fields
        const categoryFields = {
            'Flower': [
                { id: 'name', label: 'Strain Name / THC%', type: 'text', required: true, sortable: true },
                { id: 'type', label: 'Type (Indica/Sativa/Hybrid)', type: 'select', options: ['Indica', 'Sativa', 'Hybrid'], required: true, sortable: true },
                { id: 'grower', label: 'Grower/Brand Name', type: 'text', required: true, sortable: true },
                { id: 'description', label: 'Description (Effect/Notes)', type: 'textarea' },
                { id: 'terpenes', label: 'Key Terpenes (e.g., Myrcene, Linalool)', type: 'text' },
                { id: 'price_1g', label: 'Price (1 gram)', type: 'text', required: true, placeholder: '$9 - $12', priceField: true, sortable: true }, 
                { id: 'price_35g', label: 'Price (3.5g / Eighth)', type: 'text', required: true, placeholder: '$25 - $40', priceField: true, sortable: true },
                { id: 'price_7g', label: 'Price (7g / Quarter)', type: 'text', required: false, placeholder: '$50 - $80', priceField: true, sortable: true },
                { id: 'staffNotes', label: 'Internal Staff Notes (Admin Only)', type: 'textarea' } 
            ],
            'Concentrates': [
                { id: 'name', label: 'Product Name (e.g., Live Resin)', type: 'text', required: true, sortable: true },
                { id: 'brand', label: 'Brand', type: 'text', required: true, sortable: true },
                { id: 'type', label: 'Type', type: 'select', options: ['Indica', 'Sativa', 'Hybrid', 'N/A'], required: false, sortable: true },
                { id: 'format', label: 'Format (Resin/Rosin)', type: 'select', options: ['Live Resin', 'Live Rosin'], required: true, sortable: true }, 
                { id: 'potency', label: 'THC/Potency %', type: 'text' },
                { id: 'description', label: 'Description/Texture', type: 'textarea' },
                { id: 'price', label: 'Price (per unit)', type: 'text', required: true, priceField: true, sortable: true },
                { id: 'staffNotes', label: 'Internal Staff Notes (Admin Only)', type: 'textarea' } 
            ],
            'Cartridges': [
                { id: 'name', label: 'Strain/Flavor', type: 'text', required: true, sortable: true },
                { id: 'brand', label: 'Brand', type: 'text', required: true, sortable: true },
                { id: 'type', label: 'Type', type: 'select', options: ['Indica', 'Sativa', 'Hybrid', 'N/A'], required: false, sortable: true },
                { id: 'format_type', label: 'Content Type (Rosin/Resin)', type: 'select', options: ['Live Rosin', 'Live Resin', 'Distillate', 'Oil'], required: true, sortable: true }, 
                { id: 'volume', label: 'Volume (g)', type: 'select', options: ['0.5g', '1g', '2g'], required: true, sortable: true }, 
                { id: 'device_type', label: 'Device (510/AIO)', type: 'select', options: ['510 Screw On', 'All-In-One'], required: true, sortable: true }, 
                { id: 'potency', label: 'THC/Potency %', type: 'text' },
                { id: 'price', label: 'Price', type: 'text', required: true, priceField: true, sortable: true },
                { id: 'staffNotes', label: 'Internal Staff Notes (Admin Only)', type: 'textarea' } 
            ],
            'Edibles': [
                { id: 'name', label: 'Product Name', type: 'text', required: true, sortable: true },
                { id: 'brand', label: 'Brand', type: 'text', required: true, sortable: true },
                { id: 'type', label: 'Type', type: 'select', options: ['Indica', 'Sativa', 'Hybrid', 'N/A'], required: false, sortable: true },
                { id: 'cannabinoids', label: 'Minor Cannabinoids', type: 'select', options: ['THC', 'CBD', 'CBG', 'CBN', 'CBC', 'Other'], required: false, sortable: true }, // UPDATED FIELD TYPE
                { id: 'dosage', label: 'Total Dosage (e.g., 100mg)', type: 'text' },
                { id: 'flavor', label: 'Flavor/Type', type: 'text' },
                { id: 'price', label: 'Price', type: 'text', required: true, priceField: true, sortable: true },
                { id: 'staffNotes', label: 'Internal Staff Notes (Admin Only)', type: 'textarea' } 
            ],
            'Topicals': [
                { id: 'name', label: 'Product Name', type: 'text', required: true, sortable: true },
                { id: 'brand', label: 'Brand', type: 'text', required: true, sortable: true },
                { id: 'form', label: 'Product Form', type: 'select', options: ['Lotion', 'Balm', 'Salt', 'Oil', 'Other'], required: true, sortable: true }, 
                { id: 'size', label: 'Size/Volume', type: 'text' },
                { id: 'cbd_ratio', label: 'CBD:THC Ratio', type: 'text' },
                { id: 'price', label: 'Price', type: 'text', required: true, priceField: true, sortable: true },
                { id: 'staffNotes', label: 'Internal Staff Notes (Admin Only)', type: 'textarea' } 
            ],
            'Tinctures': [ 
                { id: 'name', label: 'Product Name', type: 'text', required: true, sortable: true },
                { id: 'brand', label: 'Brand', type: 'text', required: true, sortable: true },
                { id: 'ratio', label: 'Cannabinoid Ratio', type: 'select', options: ['1:1', '5:1 CBD', 'CBD Only', 'THC Only', 'Other'], required: true, sortable: true }, 
                { id: 'potency', label: 'Potency (mg)', type: 'text' },
                { id: 'size', label: 'Size (ml)', type: 'text' },
                { id: 'price', label: 'Price', type: 'text', required: true, priceField: true, sortable: true },
                { id: 'staffNotes', label: 'Internal Staff Notes (Admin Only)', type: 'textarea' } 
            ],
            'Pre-Rolls': [
                { id: 'name', label: 'Strain Name', type: 'text', required: true, sortable: true },
                { id: 'type', label: 'Type', type: 'select', options: ['Indica', 'Sativa', 'Hybrid', 'N/A'], required: false, sortable: true },
                { id: 'weight', label: 'Weight (g)', type: 'select', options: ['0.5g', '1g', '1.5g', 'Other'], required: true, sortable: true }, 
                { id: 'packaging', label: 'Packaging', type: 'select', options: ['Singles', 'Packs', 'Other'], required: true, sortable: true }, 
                { id: 'infused', label: 'Infused?', type: 'select', options: ['No', 'Yes'], required: true, sortable: true }, 
                { id: 'potency', label: 'Potency/Notes', type: 'text' },
                { id: 'price', label: 'Price', type: 'text', required: true, priceField: true, sortable: true },
                { id: 'staffNotes', label: 'Internal Staff Notes (Admin Only)', type: 'textarea' } 
            ],
            'Specials': [
                { id: 'name', label: 'Special Name (e.g., BOGO Deal)', type: 'text', required: true, sortable: true },
                { id: 'category_target', label: 'Target Category (e.g., Edibles)', type: 'text' },
                { id: 'description', label: 'Full Deal Details', type: 'textarea', required: true },
                { id: 'price', label: 'New Price/Discount', type: 'text', required: true, priceField: true, sortable: true },
                { id: 'staffNotes', label: 'Internal Staff Notes (Admin Only)', type: 'textarea' } 
            ],
        };

        const allCategories = Object.keys(categoryFields);
        const navCategories = ['All Products', 'Specials', ...allCategories.filter(c => c !== 'Specials')]; // Specials first

        // === Firebase & Data Functions ===
        
        // Seed data for initial population if a collection is empty
        const seedData = {
            'Flower': [
                { id: 'seed1', name: 'Northern Lights (21% THC)', type: 'Indica', grower: 'Union Growers', description: 'Deeply relaxing, perfect for sleep.', terpenes: 'Myrcene, Caryophyllene', price_1g: '$10', price_35g: '$35', price_7g: '$65', isFeatured: true, isSoldOut: false, isLowStock: false, isOnSale: false, staffNotes: 'Great for beginners.' }, 
                { id: 'seed2', name: 'Sour Diesel (26% THC)', type: 'Sativa', grower: 'Pacific Organics', description: 'Energetic and euphoric, great for daytime use.', terpenes: 'Limonene, Caryophyllene', price_1g: '$12', price_35g: '$40', price_7g: '$80', isFeatured: false, isSoldOut: false, isLowStock: true, isOnSale: false, staffNotes: '' },
                { id: 'seed3', name: 'GSC (23% THC)', type: 'Hybrid', grower: 'Harmony Farms', description: 'Balanced effects, body relaxation with mental uplift.', terpenes: 'Linalool, Pinene', price_1g: '$9', price_35g: '$30', price_7g: '$55', isFeatured: false, isSoldOut: true, isLowStock: false, isOnSale: true, staffNotes: '' }, // Sold Out, but marked as Sale for test
            ],
            'Concentrates': [
                { id: 'seed4', name: 'Blue Dream Live Resin', brand: 'Extraction Co.', type: 'Hybrid', format: 'Live Resin', potency: '75%', description: 'Sweet berry flavor, smooth texture.', price: '$40/gram', isFeatured: false, isSoldOut: false, isLowStock: false, isOnSale: false, staffNotes: '' },
            ],
            'Cartridges': [
                { id: 'seed6', name: 'Strawberry Banana', brand: 'Vape King', type: 'Hybrid', format_type: 'Distillate', volume: '1g', device_type: '510 Screw On', potency: '85%', price: '$55', isFeatured: true, isSoldOut: false, isLowStock: false, isOnSale: true, staffNotes: 'Old batch, push this sale item.' },
                { id: 'seed7_cart', name: 'Pineapple Express Live Resin', brand: 'Resin Pens', type: 'Sativa', format_type: 'Live Resin', volume: '0.5g', device_type: 'All-In-One', potency: '90%', price: '$35', isFeatured: false, isSoldOut: false, isLowStock: false, isOnSale: false, staffNotes: '' }, 
            ],
            'Edibles': [
                { id: 'seed8', name: 'Blueberry Gummies', brand: 'Chew Factory', type: 'Hybrid', cannabinoids: 'CBD', dosage: '100mg', flavor: 'Blueberry', price: '$22', isFeatured: false, isSoldOut: false, isLowStock: false, isOnSale: false, staffNotes: '' }, // ADDED CANNABINOIDS
                { id: 'seed9_edible', name: 'Sativa Fruit Chews', brand: 'Gummy Goodness', type: 'Sativa', cannabinoids: 'CBG', dosage: '50mg', flavor: 'Mango', price: '$18', isFeatured: false, isSoldOut: false, isLowStock: false, isOnSale: false, staffNotes: '' }, 
            ],
            'Topicals': [
                { id: 'seed9', name: 'CBD Relief Balm', brand: 'Wellness Co.', form: 'Balm', size: '4oz', cbd_ratio: '1:0 (1000mg CBD)', price: '$45', isFeatured: false, isSoldOut: false, isLowStock: false, isOnSale: false, staffNotes: '' },
            ],
            'Tinctures': [
                { id: 'seed10', name: 'Sleep Formula Drops', brand: 'Herbal Solutions', ratio: '1:1', potency: '500mg', size: '30ml', price: '$35', isFeatured: false, isSoldOut: false, isLowStock: false, isOnSale: false, staffNotes: '' },
            ],
            'Pre-Rolls': [
                 { id: 'seed11', name: 'Wedding Cake Single', type: 'Hybrid', weight: '1g', packaging: 'Singles', infused: 'No', potency: '28% THC', price: '$12', isFeatured: true, isSoldOut: false, isLowStock: false, isOnSale: false, staffNotes: '' },
            ],
            'Specials': [
                { id: 'seed13_manual', name: 'BOGO Tuesday Deal', category_target: 'All Products', description: 'Buy one, get one 50% off on all accessories.', price: 'Varies', isFeatured: false, isSoldOut: false, isLowStock: false, isOnSale: true, staffNotes: 'Must mention code "BOGO50"' },
            ]
        };
const firebaseConfig = {
  apiKey: "AIzaSyCpGjsm0Uawcfqjk_jwS1POpBXlXWGLcGE",
  authDomain: "union-live-menu.firebaseapp.com",
  projectId: "union-live-menu",
  storageBucket: "union-live-menu.firebasestorage.app",
  messagingSenderId: "724633408861",
  appId: "1:724633408861:web:82e65fae1db6e95a3404b4",
  measurementId: "G-E6C1E25NLW"
};
        // Helper to get the correct public collection path
        function getCollectionPath(category) {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            return `artifacts/${appId}/public/data/${category}`;
        }

        // --- Core Utility Functions (Needed early) ---

        // Simple message display instead of alert
        window.showMessage = (text, isError = false) => {
            let messageBox = document.getElementById('message-box');
            if (!messageBox) return; 
            
            messageBox.style.backgroundColor = isError ? '#dc2626' : '#22352F';
            messageBox.textContent = text;
            messageBox.classList.remove('hidden', 'opacity-0');
            messageBox.classList.add('opacity-100');

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, 3000);
        }
        
        // Function to extract price for sorting
        function extractPrice(priceStr) {
            const match = priceStr ? String(priceStr).match(/(\d+\.?\d*)/) : null;
            return match ? parseFloat(match[1]) : (currentSortDirection === 'asc' ? Infinity : -Infinity);
        }

        // --- Firebase Data and CRUD Operations ---

        async function seedCollection(category) {
            if (!window.db || !seedData[category] || Object.keys(inventory[category]).length > 0) return;
            const batch = window.writeBatch(window.db);
            const path = getCollectionPath(category);
            const itemsToSeed = seedData[category];

            itemsToSeed.forEach(item => {
                const docRef = window.doc(window.db, path, item.id);
                batch.set(docRef, { ...item, category: category }); 
            });

            try {
                await batch.commit();
                console.log(`Seeded ${category} collection.`);
            } catch (e) {
                console.error(`Seeding ${category} failed:`, e);
            }
        }

        function setupDataListeners() {
            allCategories.forEach(category => {
                const path = getCollectionPath(category);
                const q = window.query(window.collection(window.db, path));
                
                window.onSnapshot(q, (snapshot) => {
                    const itemsMap = {};
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        itemsMap[doc.id] = { 
                            id: doc.id, 
                            ...data, 
                            category: category,
                            isFeatured: !!data.isFeatured,
                            isSoldOut: data.isSoldOut !== undefined ? !!data.isSoldOut : false,
                            isLowStock: data.isLowStock !== undefined ? !!data.isLowStock : false,
                            isOnSale: data.isOnSale !== undefined ? !!data.isOnSale : false 
                        };
                    });
                    inventory[category] = itemsMap;
                    
                    seedCollection(category);
                    renderMenu();
                    
                    const loadingIndicator = document.getElementById('loading-indicator');
                    if (loadingIndicator) {
                        loadingIndicator.classList.add('hidden');
                    }
                }, (error) => {
                    console.error(`Error listening to Firestore for ${category}:`, error);
                    const loadingIndicator = document.getElementById('loading-indicator');
                    if (loadingIndicator) {
                        loadingIndicator.textContent = `Error loading menu. Please refresh.`;
                        loadingIndicator.classList.add('text-red_sale');
                    }
                });
            });
        }
        
        async function saveItem(formData, isEdit, itemId) {
            if (!window.db) { showMessage("Cannot save: Database connection is not active.", true); return; }

            const category = formData.category;
            const path = getCollectionPath(category);
            const collectionRef = window.collection(window.db, path);

            formData.isFeatured = formData.isFeatured === 'on';
            formData.isSoldOut = formData.isSoldOut === 'on'; 
            formData.isLowStock = formData.isLowStock === 'on';
            formData.isOnSale = formData.isOnSale === 'on'; 
            
            delete formData.category; 
            delete formData.id; 
            formData.updatedAt = new Date().toISOString();

            try {
                if (isEdit && itemId) {
                    await window.setDoc(window.doc(collectionRef, itemId), formData, { merge: true });
                    showMessage('Item updated successfully!');
                } else {
                    const newItemRef = window.doc(collectionRef);
                    await window.setDoc(newItemRef, {...formData, category: category }); 
                    showMessage('New item added successfully!');
                }
            } catch (e) {
                console.error("Error saving document: ", e);
                showMessage(`Error saving: ${e.message}`, true);
            }
            hideCrudModal();
        }

        async function executeDelete() {
            if (!window.db) { showMessage("Cannot delete: Database connection is not active.", true); hideDeleteModal(); return; }
            if (!deleteItemDetails) return;
            
            const { id, category } = deleteItemDetails;
            const path = getCollectionPath(category);

            try {
                await window.deleteDoc(window.doc(window.db, path, id));
                showMessage(`Deleted item: ${deleteItemDetails.name}`);
            } catch (e) {
                console.error("Error deleting document: ", e);
                showMessage(`Error deleting: ${e.message}`, true);
            }
            hideDeleteModal();
        }


        // --- UI/Modal Logic (Requires other functions defined) ---

        // Fix: Make handlePinKeydown global so it can be accessed from HTML inline attribute
        window.handlePinKeydown = (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); 
                window.checkAdminKey();
            }
        };

        // Toggle Edit Mode (requires key check)
        window.toggleEditMode = (forceShow = null) => {
            const toggleBtn = document.getElementById('edit-toggle-btn');
            const icon = document.getElementById('settings-icon');
            const addItemContainer = document.getElementById('add-item-container');
            const body = document.body;

            if (forceShow === false) {
                isEditMode = false;
                body.classList.remove('admin-mode');
                document.getElementById('pin-modal').classList.add('hidden');
                
                toggleBtn.classList.remove('bg-red_sale', 'hover:bg-red-700');
                toggleBtn.classList.add('bg-sage', 'hover:bg-sage/80');
                icon.classList.remove('rotate-90');
                
                addItemContainer.classList.add('hidden');
                renderMenu();
                return;
            }

            if (!isEditMode) {
                document.getElementById('pin-modal').classList.remove('hidden');
                document.getElementById('admin-pin-input').value = '';
                document.getElementById('pin-error').textContent = '';
                document.getElementById('admin-pin-input').focus();
            } else {
                toggleEditMode(false);
            }
        };

        window.checkAdminKey = () => {
            const input = document.getElementById('admin-pin-input');
            if (input.value === 'union420') {
                isEditMode = true;
                document.body.classList.add('admin-mode');
                document.getElementById('pin-modal').classList.add('hidden');
                
                const toggleBtn = document.getElementById('edit-toggle-btn');
                toggleBtn.classList.remove('bg-sage', 'hover:bg-sage/80');
                toggleBtn.classList.add('bg-red_sale', 'hover:bg-red-700');
                document.getElementById('settings-icon').classList.add('rotate-90'); 
                
                document.getElementById('add-item-container').classList.remove('hidden');
                changeCategory(currentCategory); 
            } else {
                document.getElementById('pin-error').textContent = 'Invalid Admin Key.';
                input.value = '';
            }
        };

        window.showCrudModal = (itemId = null, categoryOverride = null) => {
            let item = null;
            let category = categoryOverride || currentCategory;

            if (itemId) {
                for (const cat of allCategories) {
                    if (inventory[cat] && inventory[cat][itemId]) {
                        item = inventory[cat][itemId];
                        category = cat; 
                        break;
                    }
                }
                if (!item) { showMessage("Error: Item data could not be loaded for editing.", true); return; }
            }
            
            const modalTitle = document.getElementById('crud-modal-title');
            const fieldsContainer = document.getElementById('crud-fields-container');
            const form = document.getElementById('crud-form');
            const saveBtn = document.getElementById('crud-save-btn');
            
            modalTitle.textContent = item ? `Edit ${item.name}` : `Add New ${category} Item`;
            saveBtn.textContent = item ? 'Update Item' : 'Create Item';
            fieldsContainer.innerHTML = ''; 

            fieldsContainer.innerHTML += `<input type="hidden" name="category" value="${category}"><input type="hidden" name="id" value="${item ? item.id : ''}">`;

            // Status Checkboxes
            const isSoldOut = item ? (item.isSoldOut === true) : false; 
            const isLowStock = item ? (item.isLowStock === true) : false;
            const isOnSale = item ? (item.isOnSale === true) : false; 
            
            fieldsContainer.innerHTML += `
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 p-4 bg-sage/10 rounded-xl shadow-inner border border-sage/20">
                    <label for="isFeatured" class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="isFeatured" name="isFeatured" class="h-5 w-5 text-red_sale rounded border-sage/50 focus:ring-red_sale" ${item?.isFeatured ? 'checked' : ''}>
                        <span class="text-base font-bold text-forest">Mark as FEATURED</span>
                    </label>
                    <label for="isOnSale" class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="isOnSale" name="isOnSale" class="h-5 w-5 text-sale_blue rounded border-sage/50 focus:ring-sale_blue" ${isOnSale ? 'checked' : ''}>
                        <span class="text-base font-bold text-forest">Mark as ON SALE</span>
                    </label>
                    <label for="isLowStock" class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="isLowStock" name="isLowStock" class="h-5 w-5 text-orange_low rounded border-sage/50 focus:ring-orange_low" ${isLowStock ? 'checked' : ''}>
                        <span class="text-base font-bold text-forest">Mark as LOW STOCK</span>
                    </label>
                    <label for="isSoldOut" class="flex items-center space-x-3 cursor-pointer sm:col-span-3">
                        <input type="checkbox" id="isSoldOut" name="isSoldOut" class="h-5 w-5 text-red_sale rounded border-sage/50 focus:ring-red_sale" ${isSoldOut ? 'checked' : ''}>
                        <span class="text-base font-bold text-forest">Sold Out (Check if OOS)</span>
                    </label>
                </div>
            `;
            
            // Dynamic Fields Generation
            categoryFields[category].forEach(field => {
                // Skip the staffNotes field here, it's added separately
                if (field.id === 'staffNotes') return; 
                
                let inputHtml = '';
                let currentValue = item && item[field.id] !== undefined ? item[field.id] : '';

                if (field.type === 'textarea') {
                    inputHtml = `<textarea id="${field.id}" name="${field.id}" rows="3" class="w-full p-3 border border-sage rounded-lg bg-white text-forest focus:outline-none focus:ring-2 focus:ring-sage" placeholder="${field.placeholder || field.label}" ${field.required ? 'required' : ''}>${currentValue}</textarea>`;
                } else if (field.type === 'select') {
                    let options = field.options.map(opt => `<option value="${opt}" ${currentValue === opt ? 'selected' : ''}>${opt}</option>`).join('');
                    inputHtml = `<select id="${field.id}" name="${field.id}" class="w-full p-3 border border-sage rounded-lg bg-white text-forest focus:outline-none focus:ring-2 focus:ring-sage" ${field.required ? 'required' : ''}>${options}</select>`;
                } else {
                    inputHtml = `<input type="${field.type}" id="${field.id}" name="${field.id}" value="${currentValue}" class="w-full p-3 border border-sage rounded-lg bg-white text-forest focus:outline-none focus:ring-2 focus:ring-sage" placeholder="${field.placeholder || field.label}" ${field.required ? 'required' : ''}>`;
                }
                
                fieldsContainer.innerHTML += `
                    <div class="mb-4">
                        <label for="${field.id}" class="block text-sm font-bold mb-2 text-forest ${field.required ? 'required' : ''}">${field.label}</label>
                        ${inputHtml}
                    </div>`;
            });
            
            // Staff Notes (Added only once at the bottom)
             fieldsContainer.innerHTML += `
                    <div class="mb-4 pt-4 border-t border-sage/30">
                        <label for="staffNotes" class="block text-sm font-bold mb-2 text-forest">Internal Staff Notes (Admin Only)</label>
                        <textarea id="staffNotes" name="staffNotes" rows="3" class="w-full p-3 border border-sage rounded-lg bg-white text-forest focus:outline-none focus:ring-2 focus:ring-sage" placeholder="e.g., Push this, Low margin, Great cross-sell item.">${item?.staffNotes || ''}</textarea>
                    </div>
                `;


            form.onsubmit = (e) => {
                e.preventDefault();
                const formData = {};
                new FormData(form).forEach((value, key) => { formData[key] = value.trim(); });
                
                const idToSave = form.querySelector('input[name="id"]').value || null;
                const isEditing = !!idToSave;
                
                saveItem(formData, isEditing, idToSave);
            };

            document.getElementById('crud-modal').classList.remove('hidden');
        };

        window.hideCrudModal = () => { document.getElementById('crud-modal').classList.add('hidden'); };
        window.hideItemDetailModal = () => { document.getElementById('item-detail-modal').classList.add('hidden'); };
        window.showDeleteModal = (itemId) => { 
            for (const cat of allCategories) {
                if (inventory[cat] && inventory[cat][itemId]) {
                    deleteItemDetails = inventory[cat][itemId];
                    break;
                }
            }
            if (!deleteItemDetails) { showMessage("Error: Could not find item to delete.", true); return; }
            document.getElementById('delete-item-name').textContent = deleteItemDetails.name;
            document.getElementById('delete-modal').classList.remove('hidden');
        };
        window.hideDeleteModal = () => { document.getElementById('delete-modal').classList.add('hidden'); deleteItemDetails = null; };
        window.showCategorySelectionModal = () => { 
            const container = document.getElementById('category-buttons-container');
            container.innerHTML = allCategories.map(category => `
                <button onclick="hideCategorySelectionModal(); showCrudModal(null, '${category}')" class="bg-sage text-cream p-4 rounded-lg font-bold hover:bg-forest transition btn-brand">
                    ${category}
                </button>
            `).join('');
            document.getElementById('category-selection-modal').classList.remove('hidden');
        };
        window.hideCategorySelectionModal = () => { document.getElementById('category-selection-modal').classList.add('hidden'); };
        
        window.showItemDetailModal = (itemId) => {
            let item = null;
            // FIX: Check if isEditMode is true, if so, allow modal to open for admin
            if (isEditMode) {
                for (const cat of allCategories) {
                    if (inventory[cat] && inventory[cat][itemId]) { item = inventory[cat][itemId]; break; }
                }
            } else {
                // Original customer view logic
                for (const cat of allCategories) {
                    if (inventory[cat] && inventory[cat][itemId]) { item = inventory[cat][itemId]; break; }
                }
                if (!item) { showMessage("Error: Product details not found.", true); return; }
            }

            if (!item) { showMessage("Error: Product details not found.", true); return; }

            const modalTitle = document.getElementById('detail-modal-title');
            const modalBody = document.getElementById('detail-modal-body');
            
            modalTitle.textContent = item.name;
            
            let html = `<p class="text-sm font-semibold text-sage/90 mb-4">${item.category.toUpperCase()} | ${item.brand || item.grower || ''}</p>`;
            
            // Dynamic Price Display
            html += `<div class="p-4 bg-sage/10 rounded-lg space-y-2 border border-sage/20"><h4 class="text-lg font-bold text-forest">Pricing Options</h4>`;

            if (item.category === 'Flower') {
                if (item.price_1g) html += `<p class="flex justify-between font-medium"><span>1 gram:</span> <span class="text-xl font-bold ${item.isFeatured ? 'text-red_sale' : 'text-forest'}">${item.price_1g}</span></p>`;
                if (item.price_35g) html += `<p class="flex justify-between font-medium"><span>3.5 grams (Eighth):</span> <span class="text-lg font-semibold">${item.price_35g}</span></p>`;
                if (item.price_7g) html += `<p class="flex justify-between font-medium"><span>7 grams (Quarter):</span> <span class="text-lg font-semibold">${item.price_7g}</span></p>`;
            } else {
                 html += `<p class="flex justify-between font-medium"><span>Unit Price:</span> <span class="text-xl font-bold ${item.isFeatured ? 'text-red_sale' : 'text-forest'}">${item.price || 'N/A'}</span></p>`;
            }
            html += `</div>`;

            // Full Details
            html += `<div class="mt-6 space-y-3"><h4 class="text-lg font-bold text-forest border-b border-sage/30 pb-1">Product Details</h4>`;

            if (item.description) { html += `<p class="text-base">${item.description}</p>`; }

            const detailFields = categoryFields[item.category].filter(f => !['name', 'description', 'price', 'price_1g', 'price_35g', 'price_7g', 'staffNotes'].includes(f.id));
            
            detailFields.forEach(field => {
                if (item[field.id]) {
                    html += `<p class="text-sm"><span class="font-semibold text-forest/80">${field.label.split('(')[0].trim()}:</span> ${item[field.id]}</p>`;
                }
            });
            html += `</div>`;
            
            // --- NEW: Internal Staff Notes (ADMIN ONLY) ---
            if (isEditMode && item.staffNotes) {
                html += `
                    <div class="mt-6 p-4 bg-red-100 border border-red_sale rounded-lg">
                        <h4 class="text-lg font-bold text-red_sale">Internal Staff Notes</h4>
                        <p class="text-forest text-base whitespace-pre-wrap">${item.staffNotes}</p>
                    </div>
                `;
            }

            document.getElementById('detail-modal-body').innerHTML = html;
            document.getElementById('item-detail-modal').classList.remove('hidden');
        };

        window.changeCategory = (category) => {
            currentCategory = category;
            
            const supportsTypeFilter = ['All Products', 'Flower', 'Cartridges', 'Concentrates', 'Pre-Rolls', 'Edibles'].includes(category);
            if (!supportsTypeFilter) { currentTypeFilter = 'All'; }
            
            // Reset ALL specific filters when changing categories
            currentFormatFilter = 'All';
            currentDeviceFilter = 'All';
            currentVolumeFilter = 'All';
            currentRatioFilter = 'All';
            currentPackagingFilter = 'All';
            currentInfusionFilter = 'All';
            currentFormFilter = 'All';
            currentWeightFilter = 'All';
            currentCannabinoidFilter = 'All'; 

            const addItemContainer = document.getElementById('add-item-container');
            if (isEditMode) {
                const clickAction = (currentCategory === 'All Products') ? 'showCategorySelectionModal()' : `showCrudModal(null, '${currentCategory}')`;
                const buttonText = (currentCategory === 'All Products') ? '+ Add New Product' : `+ Add New ${currentCategory} Item`;

                addItemContainer.innerHTML = `<button onclick="${clickAction}" class="w-full bg-forest text-cream p-3 rounded-xl font-bold hover:bg-sage transition btn-brand text-lg">${buttonText}</button>`;
                addItemContainer.classList.remove('hidden');
            } else {
                 addItemContainer.classList.add('hidden');
            }
            
            renderCategories();
            renderControls();
            renderMenu();
        };
        
        // --- Search, Filter & Sort Functions ---
        window.handleSearch = (event) => { currentSearchQuery = event.target.value.toLowerCase().trim(); renderControls(); renderMenu(); };
        window.handleTypeFilter = (type) => { currentTypeFilter = type; renderControls(); renderMenu(); };
        window.handleFormatFilter = (format) => { currentFormatFilter = format; renderControls(); renderMenu(); };
        window.handleDeviceFilter = (device) => { currentDeviceFilter = device; renderControls(); renderMenu(); };
        window.handleVolumeFilter = (volume) => { currentVolumeFilter = volume; renderControls(); renderMenu(); };
        window.handleRatioFilter = (ratio) => { currentRatioFilter = ratio; renderControls(); renderMenu(); };
        window.handleFormFilter = (form) => { currentFormFilter = form; renderControls(); renderMenu(); }; 
        window.handleWeightFilter = (weight) => { currentWeightFilter = weight; renderControls(); renderMenu(); };
        window.handlePackagingFilter = (packaging) => { currentPackagingFilter = packaging; renderControls(); renderMenu(); };
        window.handleInfusionFilter = (infused) => { currentInfusionFilter = infused; renderControls(); renderMenu(); };
        window.handleCannabinoidFilter = (cannabinoid) => { currentCannabinoidFilter = cannabinoid; renderControls(); renderMenu(); }; 
        window.handleSortChange = (event) => { currentSortBy = event.target.value; renderControls(); renderMenu(); };
        window.handleSortDirection = (direction) => { currentSortDirection = direction; renderControls(); renderMenu(); };
        
        // --- RENDER CONTROLS ---
        
        function renderControls() {
            const controlsContainer = document.getElementById('controls-container');
            const searchPlaceholder = currentCategory === 'All Products' ? 'Search all products...' : `Search in ${currentCategory}...`;

            // Start of controls HTML
            let html = `<div class="mb-2"><input type="text" id="search-input" oninput="handleSearch(event)" value="${currentSearchQuery}" class="w-full p-2 border-2 border-sage rounded-xl bg-white text-forest focus:outline-none focus:ring-2 focus:ring-sage placeholder-sage/70 font-serif text-sm" placeholder="${searchPlaceholder}"></div>`;
            
            // --- Type Filter Bar (Indica/Sativa/Hybrid) ---
            const typeFilters = ['All Types', 'Indica', 'Sativa', 'Hybrid'];
            const supportsTypeFilter = ['All Products', 'Flower', 'Cartridges', 'Concentrates', 'Pre-Rolls', 'Edibles'].includes(currentCategory);

            if (supportsTypeFilter) {
                html += `<div class="mb-2 p-2 bg-cream shadow-inner rounded-xl border border-sage/30">
                                <label class="text-xs font-bold text-forest mb-1 block">Filter by Type:</label>
                                <div class="flex flex-wrap gap-2">`;
                
                typeFilters.forEach(type => {
                    const filterValue = type === 'All Types' ? 'All' : type;
                    const isActive = currentTypeFilter === filterValue;
                    const buttonClass = isActive ? 'bg-forest text-cream' : 'bg-white text-forest border border-sage/50 hover:bg-sage/10';
                    
                    html += `<button onclick="handleTypeFilter('${filterValue}')" class="p-1.5 px-3 rounded-lg transition text-xs font-semibold btn-brand ${buttonClass}">${type}</button>`;
                });
                html += `</div></div>`;
            }

            // --- Edibles Cannabinoid Filter Bar (CBD / CBC / CBG / CBN) ---
            if (currentCategory === 'Edibles') {
                const cannabinoidFilters = ['All Cannabinoids', 'THC', 'CBD', 'CBG', 'CBN', 'CBC'];
                 html += `<div class="mb-2 p-2 bg-cream shadow-inner rounded-xl border border-sage/30">
                                  <label class="text-xs font-bold text-forest mb-1 block">Filter by Cannabinoid Focus:</label>
                                  <div class="flex flex-wrap gap-2">`;
                
                 cannabinoidFilters.forEach(cb => {
                     const filterValue = cb === 'All Cannabinoids' ? 'All' : cb;
                     const isActive = currentCannabinoidFilter === filterValue;
                     const buttonClass = isActive ? 'bg-forest text-cream' : 'bg-white text-forest border border-sage/50 hover:bg-sage/10';
                     
                     html += `<button onclick="handleCannabinoidFilter('${filterValue}')" class="p-1.5 px-3 rounded-lg transition text-xs font-semibold btn-brand ${buttonClass}">${cb}</button>`;
                 });
                 html += `</div></div>`;
             }

            // --- Concentrates Format Filter Bar (Live Rosin / Live Resin) ---
            if (currentCategory === 'Concentrates') {
                const formatFilters = ['All Formats', 'Live Resin', 'Live Rosin'];
                html += `<div class="mb-2 p-2 bg-cream shadow-inner rounded-xl border border-sage/30">
                                <label class="text-xs font-bold text-forest mb-1 block">Filter by Concentrate Format:</label>
                                <div class="flex flex-wrap gap-2">`;
                
                formatFilters.forEach(format => {
                    const filterValue = format === 'All Formats' ? 'All' : format;
                    const isActive = currentFormatFilter === filterValue;
                    const buttonClass = isActive ? 'bg-forest text-cream' : 'bg-white text-forest border border-sage/50 hover:bg-sage/10';
                    
                    html += `<button onclick="handleFormatFilter('${filterValue}')" class="p-1.5 px-3 rounded-lg transition text-xs font-semibold btn-brand ${buttonClass}">${format}</button>`;
                });
                html += `</div></div>`;
            }

            // --- Tinctures Ratio Filter Bar ---
             if (currentCategory === 'Tinctures') {
                const ratioFilters = ['All Ratios', '1:1', '5:1 CBD', 'CBD Only', 'THC Only'];
                html += `<div class="mb-2 p-2 bg-cream shadow-inner rounded-xl border border-sage/30">
                                <label class="text-xs font-bold text-forest mb-1 block">Filter by Cannabinoid Ratio:</label>
                                <div class="flex flex-wrap gap-2">`;
                
                ratioFilters.forEach(ratio => {
                    const filterValue = ratio === 'All Ratios' ? 'All' : ratio;
                    const isActive = currentRatioFilter === filterValue;
                    const buttonClass = isActive ? 'bg-forest text-cream' : 'bg-white text-forest border border-sage/50 hover:bg-sage/10';
                    
                    html += `<button onclick="handleRatioFilter('${filterValue}')" class="p-1.5 px-3 rounded-lg transition text-xs font-semibold btn-brand ${buttonClass}">${ratio}</button>`;
                });
                html += `</div></div>`;
            }

            // --- Topicals Form Filter Bar ---
             if (currentCategory === 'Topicals') {
                const formFilters = ['All Forms', 'Lotion', 'Balm', 'Salt', 'Oil'];
                html += `<div class="mb-2 p-2 bg-cream shadow-inner rounded-xl border border-sage/30">
                                <label class="text-xs font-bold text-forest mb-1 block">Filter by Product Form:</label>
                                <div class="flex flex-wrap gap-2">`;
                
                formFilters.forEach(form => {
                    const filterValue = form === 'All Forms' ? 'All' : form;
                    const isActive = currentFormFilter === filterValue;
                    const buttonClass = isActive ? 'bg-forest text-cream' : 'bg-white text-forest border border-sage/50 hover:bg-sage/10';
                    
                    html += `<button onclick="handleFormFilter('${filterValue}')" class="p-1.5 px-3 rounded-lg transition text-xs font-semibold btn-brand ${buttonClass}">${form}</button>`;
                });
                html += `</div></div>`;
            }

            // --- Cartridges Filters (Format, Size, Device) ---
            if (currentCategory === 'Cartridges') {
