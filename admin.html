<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN - Union Menu</title>
    
    <!-- Custom Google Fonts for branding -->
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Lora:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // === Custom Tailwind Configuration for Branding ===
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cream: '#F8F2E2',     // Light background
                        sage: '#808A6F',      // Accent and detail
                        forest: '#22352F',    // Dark text and primary elements
                        red_sale: '#EF4444',    // Red color for sold out/featured status
                        orange_low: '#F59E0B', // Orange for low stock
                        sale_blue: '#3B82F6',  // Blue for Sale status
                    },
                    fontFamily: {
                        script: ['Great Vibes', 'cursive'], // Script font for main title
                        serif: ['Lora', 'serif'],           // Serif font for body text
                        sans: ['Inter', 'sans-serif'],      // Fallback sans
                    },
                }
            }
        }
    </script>
    <style>
        /* Global Styles */
        body {
            font-family: 'Lora', serif;
            background-color: #808A6F; /* Sage Background */
            color: #22352F; /* Forest Text */
        }
        /* Fix for scrollable categories bar */
        .categories-container::-webkit-scrollbar {
            display: none;
        }
        .categories-container {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        /* Custom styles for aesthetic buttons */
        .btn-brand {
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn-brand:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Class for sold-out items (Customer View) */
        .sold-out {
            /* Dim the entire card to show it's inactive/out */
            opacity: 0.55; 
            filter: grayscale(80%);
            position: relative;
        }
        
        /* Line clamp for description */
        .line-clamp-2 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
        }
        /* Mobile optimization: smaller padding on tabs for smaller screens */
        @media (max-width: 640px) {
            #category-tabs button {
                padding: 0.75rem 0.5rem; /* Reduced horizontal padding */
                font-size: 0.875rem; /* text-sm */
            }
            .categories-container svg {
                width: 1.1rem;
                height: 1.1rem;
            }
            .modal-content-area {
                max-height: 80vh; /* Allow more space for mobile modal content */
                overflow-y: auto;
            }
        }
        /* Style for admin buttons */
        .admin-controls {
            display: none; /* Hidden by default */
        }
        .modal {
            display: none; /* Hidden by default */
        }

    </style>
</head>
<body class="bg-sage min-h-screen">

    <!-- Main Container -->
    <div id="app" class="max-w-7xl mx-auto bg-cream shadow-2xl min-h-screen">

        <!-- Header and Navigation -->
        <header class="sticky top-0 z-30 shadow-lg bg-forest">
            <div class="p-4 flex justify-between items-center text-cream">
                
                <!-- Title -->
                <h1 id="main-title" class="text-3xl md:text-4xl font-script text-cream select-none">
                    Union Dispensary
                </h1>
                
                <!-- Admin Logout Button -->
                <button id="logout-button" class="admin-controls bg-red_sale text-white p-2 px-3 rounded-lg text-xs font-bold btn-brand" onclick="handleLogout()">
                    Logout
                </button>
            </div>

            <!-- Category Tabs -->
            <div id="category-tabs" class="categories-container flex overflow-x-auto border-t border-b border-cream/20 bg-forest/90 sticky top-[68px] md:top-[76px] z-20">
                <!-- Tabs rendered by JS -->
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="p-4 md:p-6">
            
            <!-- Customer Controls (Search/Sort) -->
            <div id="controls-container" class="bg-cream pt-2 pb-4 z-10">
                <!-- Controls rendered by JS -->
            </div>

            <!-- Add Item Button (Admin Only) -->
            <div id="add-item-container" class="admin-controls mb-4 p-4 bg-sage/10 rounded-xl border border-sage/50">
                <button id="add-item-button" class="bg-forest text-cream w-full p-3 rounded-lg font-bold hover:bg-forest/80 transition btn-brand text-lg" onclick="handleAddItemClick()">
                    + Add New Item to <span id="add-item-category-label">...</span>
                </button>
            </div>

            <!-- Loading Indicator -->
            <div class="text-center text-xl text-sage pt-10" id="loading-indicator">Authenticating...</div>

            <!-- Product List -->
            <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6 pt-4">
                <!-- Product cards rendered by JS -->
            </div>
        </main>
    </div>

    <!-- === MODALS === -->

    <!-- Admin Login Modal -->
    <div id="login-modal" class="modal fixed inset-0 bg-forest bg-opacity-90 flex items-center justify-center z-50 p-4">
        <div class="bg-cream p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h3 class="text-3xl font-bold text-forest mb-6 text-center">Admin Login</h3>
            <p id="login-error" class="text-center text-red_sale mb-4 font-semibold"></p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-bold text-forest mb-2">Username</label>
                    <input type="email" id="email" required class="w-full p-2 border-2 border-sage rounded-xl bg-white text-forest focus:outline-none focus:ring-2 focus:ring-sage font-serif" value="admin">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-bold text-forest mb-2">Password</label>
                    <input type="password" id="password" required class="w-full p-2 border-2 border-sage rounded-xl bg-white text-forest focus:outline-none focus:ring-2 focus:ring-sage font-serif" value="password">
                </div>
                <button type="submit" class="bg-sage text-cream w-full p-3 rounded-lg font-bold hover:bg-forest transition btn-brand text-lg">
                    Login
                </button>
            </form>
        </div>
    </div>
    
    <!-- Item Detail / Quick View Modal (Customer View) -->
    <div id="item-detail-modal" class="modal fixed inset-0 bg-forest bg-opacity-75 items-center justify-center z-40 overflow-y-auto p-4">
        <div class="bg-cream p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-lg text-forest my-8 font-serif">
            <h3 id="detail-modal-title" class="text-3xl font-bold mb-4 border-b pb-2 border-sage/50"></h3>
            <div id="detail-modal-body" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <!-- Details rendered by JS -->
            </div>
            <div class="mt-8 flex justify-end">
                <button class="bg-sage text-cream p-3 rounded-lg font-bold hover:bg-forest transition btn-brand" onclick="hideItemDetailModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Admin Edit/Add Modal -->
    <div id="admin-modal" class="modal fixed inset-0 bg-forest bg-opacity-75 items-center justify-center z-40 overflow-y-auto p-4">
        <div class="bg-cream p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-xl text-forest my-8 font-serif">
            <h3 id="admin-modal-title" class="text-3xl font-bold mb-6 border-b pb-3 border-sage/50">Edit Item</h3>
            <form id="admin-form" class="modal-content-area space-y-3 max-h-[70vh] overflow-y-auto pr-2">
                <input type="hidden" id="edit-item-id">
                <div id="admin-form-fields" class="space-y-3">
                    <!-- Fields rendered by JS -->
                </div>
                
                <!-- Admin-Only Status Fields -->
                <fieldset class="border-2 border-sage/50 p-3 rounded-xl mt-6">
                    <legend class="text-lg font-bold px-2 text-forest">Admin Status</legend>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                        <label class="flex items-center space-x-2 p-2 bg-sage/10 rounded-lg">
                            <input type="checkbox" id="isFeatured" class="h-5 w-5 text-red_sale rounded focus:ring-red_sale">
                            <span class="font-semibold text-sm">Featured ‚≠ê</span>
                        </label>
                         <label class="flex items-center space-x-2 p-2 bg-sage/10 rounded-lg">
                            <input type="checkbox" id="isOnSale" class="h-5 w-5 text-sale_blue rounded focus:ring-sale_blue">
                            <span class="font-semibold text-sm">On Sale üè∑Ô∏è</span>
                        </label>
                        <label class="flex items-center space-x-2 p-2 bg-sage/10 rounded-lg">
                            <input type="checkbox" id="isLowStock" class="h-5 w-5 text-orange_low rounded focus:ring-orange_low">
                            <span class="font-semibold text-sm">Low Stock ‚ö†Ô∏è</span>
                        </label>
                        <label class="flex items-center space-x-2 p-2 bg-sage/10 rounded-lg">
                            <input type="checkbox" id="isSoldOut" class="h-5 w-5 text-gray-600 rounded focus:ring-gray-600">
                            <span class="font-semibold text-sm">Sold Out ‚ùå</span>
                        </label>
                    </div>
                </fieldset>
                
                <!-- Staff Notes Field -->
                <div class="pt-4">
                    <label for="staffNotes" class="block text-sm font-bold text-forest mb-1">Staff Notes (Internal Use Only)</label>
                    <textarea id="staffNotes" rows="2" class="w-full p-2 border-2 border-sage/50 rounded-xl bg-white text-forest focus:outline-none focus:ring-2 focus:ring-sage font-serif"></textarea>
                </div>

            </form>
            <div class="mt-8 flex justify-between">
                <button class="bg-gray-400 text-black p-3 rounded-lg font-bold hover:bg-gray-500 transition btn-brand" onclick="hideAdminModal()">Cancel</button>
                <button class="bg-forest text-cream p-3 px-6 rounded-lg font-bold hover:bg-sage transition btn-brand text-lg" onclick="saveItem()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- *** NEW: SELECT CATEGORY MODAL *** -->
    <div id="category-select-modal" class="modal fixed inset-0 bg-forest bg-opacity-90 items-center justify-center z-50 p-4">
        <div class="bg-cream p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h3 class="text-3xl font-bold text-forest mb-6 text-center">Select Category</h3>
            <p class="text-center text-forest/80 mb-6">Which type of product are you adding?</p>
            
            <div id="category-select-buttons" class="grid grid-cols-2 gap-3">
                <!-- Category buttons rendered by JS -->
            </div>

            <div class="mt-8 flex justify-center">
                <button class="bg-gray-400 text-black p-3 rounded-lg font-bold hover:bg-gray-500 transition btn-brand" onclick="hideCategorySelectModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Global Message/Toast Notification -->
    <div id="message-box" class="hidden fixed top-24 right-4 bg-forest text-cream p-4 rounded-lg shadow-xl opacity-0 transition-all duration-300 z-50 font-serif min-w-[200px]"></div>


    <!-- Firebase Imports and Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // ADMIN AUTH: Import Email/Password auth functions
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            signInWithCustomToken // <-- ADDED FOR CANVAS PREVIEW
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, query, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // setLogLevel('Debug'); // Uncomment this line to enable verbose Firebase logging

        // Global Firebase References (available to the window object)
        window.db = null;
        window.auth = null;
        window.userId = null;
        // Expose Firebase functions globally for use in the main script block
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        // ADMIN AUTH
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signInWithCustomToken = signInWithCustomToken; // <-- ADDED FOR CANVAS PREVIEW
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        // ---
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.onSnapshot = onSnapshot;
        window.doc = doc;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.query = query;
        window.writeBatch = writeBatch;
        
        // =======================================================================
        // This <script> block MUST remain separate and of type="module"
        // It handles importing the Firebase libraries.
        // =======================================================================

    </script>
    
    <!-- Main Application Logic (Exposed to window for event handlers) -->
    <script>
        // === App State and Configuration ===
        
        // =======================================================================
        // FIREBASE CONFIGURATION
        // =======================================================================
        
        let firebaseConfig = {};
        let appId = 'union-live-menu'; // Default App ID (your project ID)

        // --- CANVAS PREVIEW LOGIC ---
        // Try to load config from the canvas environment first
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
                console.log("Loaded Firebase config from canvas environment.");
            } catch (e) {
                console.error("Failed to parse canvas Firebase config.", e);
            }
        }
        
        // If canvas config fails or isn't present, fall back to your hardcoded config
        if (!firebaseConfig.apiKey) {
            console.log("Using fallback Firebase config (for GitHub).");
            // *** PASTE YOUR FIREBASE CONFIG OBJECT HERE ***
            // This is the file to copy/paste into GitHub
            // Replace this placeholder object with your own
            firebaseConfig = {
    apiKey: "AIzaSyCpGjsm0Uawcfqjk_jwS1POpBXlXWGLcGE",
  authDomain: "union-live-menu.firebaseapp.com",
  projectId: "union-live-menu",
  storageBucket: "union-live-menu.firebasestorage.app",
  messagingSenderId: "724633408861",
  appId: "1:724633408861:web:82e65fae1db6e95a3404b4",
  measurementId: "G-E6C1E25NLW"
};
        }

        // --- CANVAS PREVIEW LOGIC ---
        // Use canvas appId if available, otherwise use your hardcoded one
        if (typeof __app_id !== 'undefined' && __app_id) {
            appId = __app_id;
            console.log("Using canvas app ID:", appId);
        } else if (firebaseConfig.projectId) {
            appId = firebaseConfig.projectId; // Fallback to Project ID
            console.log("Using fallback app ID (projectId):", appId);
        } else {
            console.warn("No app ID found. Using default.");
        }
        
        // =======================================================================
        // (End of config logic)
        // =======================================================================


        let inventory = {}; 
        let currentCategory = 'Flower';
        let isAdmin = false; // ADMIN STATE
        let currentSearchQuery = '';
        let currentTypeFilter = 'All'; 
        let currentSortBy = 'name'; 
        let currentSortDirection = 'asc'; 
        let currentFormatFilter = 'All'; 
        let currentDeviceFilter = 'All'; 
        let currentVolumeFilter = 'All';
        let currentRatioFilter = 'All'; 
        let currentPackagingFilter = 'All'; 
        let currentInfusionFilter = 'All'; 
        let currentFormFilter = 'All'; 
        let currentWeightFilter = 'All'; 
        let currentCannabinoidFilter = 'All'; 

        
        // Icon mapping for categories (using elegant, simple SVGs)
        const categoryIcons = {
            'Flower': `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20"/><path d="M17 5H7"/><path d="M17 19H7"/><path d="M19 12c0 3.866-3.134 7-7 7s-7-3.134-7-7c0-3.866 3.134-7 7-7s7 3.134 7 7z"/></svg>`, 
            'Concentrates': `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 11V7a4 4 0 0 0-8 0v4"/><path d="M22 11h-2a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2v-8z"/><path d="M2 11h2a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H2v-8z"/><path d="M10 21h4"/></svg>`,
            'Cartridges': `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 11V7a4 4 0 0 0-8 0v4"/><path d="M12 21a2 2 0 0 0 2-2v-8a2 2 0 0 0-4 0v8a2 2 0 0 0 2 2z"/></svg>`,
            'Edibles': `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2z"/><path d="M16.2 7.8c-1-1-2.2-1.8-3.6-2.2-1.4-.4-2.8-.2-4.2.6-1.4.8-2.6 2-3.4 3.4-.8 1.4-1 3-1 4.6 0 1.6.4 3.2 1.2 4.6.8 1.4 2 2.6 3.4 3.4 1.4.8 3 .8 4.6.8s3.2-.4 4.6-1.2c1.4-.8 2.6-2 3.4-3.4.8-1.4 1.2-3 1.2-4.6 0-1.6-.4-3.2-1.2-4.6-.8-1.4-2-2.6-3.4-3.4z"/><path d="M12 18c-3.3 0-6-2.7-6-6s2.7-6 6-6 6 2.7 6 6-2.7 6-6 6z"/></svg>`,
            'Topicals': `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22a7 7 0 0 0-7-7h14a7 7 0 0 0-7 7z"/><path d="M12 15V3.5A1.5 1.5 0 0 1 13.5 2h0A1.5 1.5 0 0 1 15 3.5v3.5"/><path d="M12 15V3.5A1.5 1.5 0 0 0 10.5 2h0A1.5 1.5 0 0 0 9 3.5v3.5"/></svg>`,
            'Tinctures': `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 16V9a3 3 0 0 1 6 0v7"/><path d="M10 22h4"/><path d="M10 16a3 3 0 0 1-6 0h12a3 3 0 0 1-6 0z"/><path d="M10 16h4"/></svg>`,
            'Pre-Rolls': `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6H6a4 4 0 0 0-4 4v4a4 4 0 0 0 4 4h12a4 4 0 0 0 4-4v-4a4 4 0 0 0-4-4z"/><path d="M2 10h4"/><path d="M22 10h-4"/><path d="M2 14h4"/><path d="M22 14h-4"/></svg>`,
            'Specials': `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19.5 12.5c0 1.1-.9 2-2 2s-2-.9-2-2.9.9-2 2-2c1.1 0 2 .9 2 2.9z"/><path d="M17.5 14.5c0 1.1.9 2 2 2s2-.9 2-2.9-.9-2-2-2c-1.1 0-2 .9-2 2.9z"/><path d="M12.5 19.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/><path d="M14.5 17.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/><path d="M7 12a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/><path d="M14 10.042A6.14 6.14 0 0 0 12.503 10a6.16 6.16 0 0 0-1.498.042"/><path d="M9.958 14A6.14 6.14 0 0 0 10 12.503a6.16 6.16 0 0 0-.042-1.498"/><path d="M17 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></svg>`,
            'All Products': `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 15h1.5a2.5 2.5 0 0 1 0 5H4"/><path d="M19.5 15H18a2.5 2.5 0 0 1 0 5h1.5"/><line x1="12" y1="9" x2="12" y2="15"/><line x1="9" y1="12" x2="15" y2="12"/></svg>`
        };

        // Definitive structure for each category's data fields
        // NOW INCLUDES 'staffNotes' for the admin panel
        const categoryFields = {
            'Flower': [
                { id: 'name', label: 'Strain Name / THC%', type: 'text', required: true, sortable: true },
                { id: 'type', label: 'Type (Indica/Sativa/Hybrid)', type: 'select', options: ['Indica', 'Sativa', 'Hybrid'], required: true, sortable: true },
                { id: 'grower', label: 'Grower/Brand Name', type: 'text', required: true, sortable: true },
                { id: 'description', label: 'Description (Effect/Notes)', type: 'textarea' },
                { id: 'terpenes', label: 'Key Terpenes (e.g., Myrcene, Linalool)', type: 'text' },
                { id: 'price_1g', label: 'Price (1 gram)', type: 'text', required: true, placeholder: '$9 - $12', priceField: true, sortable: true }, 
                { id: 'price_35g', label: 'Price (3.5g / Eighth)', type: 'text', required: true, placeholder: '$25 - $40', priceField: true, sortable: true },
                { id: 'price_7g', label: 'Price (7g / Quarter)', type: 'text', required: false, placeholder: '$50 - $80', priceField: true, sortable: true },
                { id: 'staffNotes', label: 'Staff Notes', type: 'textarea', adminOnly: true }, // ADMIN
            ],
            'Concentrates': [
                { id: 'name', label: 'Product Name (e.g., Live Resin)', type: 'text', required: true, sortable: true },
                { id: 'brand', label: 'Brand', type: 'text', required: true, sortable: true },
                { id: 'type', label: 'Type', type: 'select', options: ['Indica', 'Sativa', 'Hybrid', 'N/A'], required: false, sortable: true },
                { id: 'format', label: 'Format (Resin/Rosin)', type: 'select', options: ['Live Resin', 'Live Rosin'], required: true, sortable: true }, 
                { id: 'potency', label: 'THC/Potency %', type: 'text' },
                { id: 'description', label: 'Description/Texture', type: 'textarea' },
                { id: 'price', label: 'Price (per unit)', type: 'text', required: true, priceField: true, sortable: true },
                { id: 'staffNotes', label: 'Staff Notes', type: 'textarea', adminOnly: true }, // ADMIN
            ],
            'Cartridges': [
                { id: 'name', label: 'Strain/Flavor', type: 'text', required: true, sortable: true },
                { id: 'brand', label: 'Brand', type: 'text', required: true, sortable: true },
                { id: 'type', label: 'Type', type: 'select', options: ['Indica', 'Sativa', 'Hybrid', 'N/A'], required: false, sortable: true },
                { id: 'format_type', label: 'Content Type (Rosin/Resin)', type: 'select', options: ['Live Rosin', 'Live Resin', 'Distillate', 'Oil'], required: true, sortable: true }, 
                { id: 'volume', label: 'Volume (g)', type: 'select', options: ['0.5g', '1g', '2g'], required: true, sortable: true }, 
                { id: 'device_type', label: 'Device (510/AIO)', type: 'select', options: ['510 Screw On', 'All-In-One'], required: true, sortable: true }, 
                { id: 'potency', label: 'THC/Potency %', type: 'text' },
                { id: 'price', label: 'Price', type: 'text', required: true, priceField: true, sortable: true },
                { id: 'staffNotes', label: 'Staff Notes', type: 'textarea', adminOnly: true }, // ADMIN
            ],
            'Edibles': [
                { id: 'name', label: 'Product Name', type: 'text', required: true, sortable: true },
                { id: 'brand', label: 'Brand', type: 'text', required: true, sortable: true },
                { id: 'type', label: 'Type', type: 'select', options: ['Indica', 'Sativa', 'Hybrid', 'N/A'], required: false, sortable: true },
                { id: 'cannabinoids', label: 'Minor Cannabinoids', type: 'select', options: ['THC', 'CBD', 'CBG', 'CBN', 'CBC', 'Other'], required: false, sortable: true },
                { id: 'dosage', label: 'Total Dosage (e.g., 100mg)', type: 'text' },
                { id: 'flavor', label: 'Flavor/Type', type: 'text' },
                { id: 'price', label: 'Price', type: 'text', required: true, priceField: true, sortable: true },
                { id: 'staffNotes', label: 'Staff Notes', type: 'textarea', adminOnly: true }, // ADMIN
            ],
            'Topicals': [
                { id: 'name', label: 'Product Name', type: 'text', required: true, sortable: true },
                { id: 'brand', label: 'Brand', type: 'text', required: true, sortable: true },
                { id: 'form', label: 'Product Form', type: 'select', options: ['Lotion', 'Balm', 'Salt', 'Oil', 'Other'], required: true, sortable: true }, 
                { id: 'size', label: 'Size/Volume', type: 'text' },
                { id: 'cbd_ratio', label: 'CBD:THC Ratio', type: 'text' },
                { id: 'price', label: 'Price', type: 'text', required: true, priceField: true, sortable: true },
                { id: 'staffNotes', label: 'Staff Notes', type: 'textarea', adminOnly: true }, // ADMIN
            ],
            'Tinctures': [ 
                { id: 'name', label: 'Product Name', type: 'text', required: true, sortable: true },
                { id: 'brand', label: 'Brand', type: 'text', required: true, sortable: true },
                { id: 'ratio', label: 'Cannabinoid Ratio', type: 'select', options: ['1:1', '5:1 CBD', 'CBD Only', 'THC Only', 'Other'], required: true, sortable: true }, 
                { id: 'potency', label: 'Potency (mg)', type: 'text' },
                { id: 'size', label: 'Size (ml)', type: 'text' },
                { id: 'price', label: 'Price', type: 'text', required: true, priceField: true, sortable: true },
                { id: 'staffNotes', label: 'Staff Notes', type: 'textarea', adminOnly: true }, // ADMIN
            ],
            'Pre-Rolls': [
                { id: 'name', label: 'Strain Name', type: 'text', required: true, sortable: true },
                { id: 'type', label: 'Type', type: 'select', options: ['Indica', 'Sativa', 'Hybrid', 'N/A'], required: false, sortable: true },
                { id: 'weight', label: 'Weight (g)', type: 'select', options: ['0.5g', '1g', '1.5g', 'Other'], required: true, sortable: true }, 
                { id: 'packaging', label: 'Packaging', type: 'select', options: ['Singles', 'Packs', 'Other'], required: true, sortable: true }, 
                { id: 'infused', label: 'Infused?', type: 'select', options: ['No', 'Yes'], required: true, sortable: true }, 
                { id: 'potency', label: 'Potency/Notes', type: 'text' },
                { id: 'price', label: 'Price', type: 'text', required: true, priceField: true, sortable: true },
                { id: 'staffNotes', label: 'Staff Notes', type: 'textarea', adminOnly: true }, // ADMIN
            ],
            'Specials': [
                { id: 'name', label: 'Special Name (e.g., BOGO Deal)', type: 'text', required: true, sortable: true },
                { id: 'category_target', label: 'Target Category (e.g., Edibles)', type: 'text' },
                { id: 'description', label: 'Full Deal Details', type: 'textarea', required: true },
                { id: 'price', label: 'New Price/Discount', type: 'text', required: true, priceField: true, sortable: true },
                { id: 'staffNotes', label: 'Staff Notes', type: 'textarea', adminOnly: true }, // ADMIN
            ],
        };

        const allCategories = Object.keys(categoryFields);
        const navCategories = ['All Products', 'Specials', ...allCategories.filter(c => c !== 'Specials')]; // Specials first

        // === Firebase & Data Functions ===
        
        // Seed data for initial population if a collection is empty
        const seedData = {
            'Flower': [
                { id: 'seed1', name: 'Northern Lights (21% THC)', type: 'Indica', grower: 'Union Growers', description: 'Deeply relaxing, perfect for sleep.', terpenes: 'Myrcene, Caryophyllene', price_1g: '$10', price_35g: '$35', price_7g: '$65', isFeatured: true, isSoldOut: false, isLowStock: false, isOnSale: false, staffNotes: 'Popular, keep stocked.' }, 
                { id: 'seed2', name: 'Sour Diesel (26% THC)', type: 'Sativa', grower: 'Pacific Organics', description: 'Energetic and euphoric, great for daytime use.', terpenes: 'Limonene, Caryophyllene', price_1g: '$12', price_35g: '$40', price_7g: '$80', isFeatured: false, isSoldOut: false, isLowStock: true, isOnSale: false, staffNotes: 'Check inventory.' },
                { id: 'seed3', name: 'GSC (23% THC)', type: 'Hybrid', grower: 'Harmony Farms', description: 'Balanced effects, body relaxation with mental uplift.', terpenes: 'Linalool, Pinene', price_1g: '$9', price_35g: '$30', price_7g: '$55', isFeatured: false, isSoldOut: true, isLowStock: false, isOnSale: true, staffNotes: 'Marked down.' },
            ],
            'Concentrates': [
                { id: 'seed4', name: 'Blue Dream Live Resin', brand: 'Extraction Co.', type: 'Hybrid', format: 'Live Resin', potency: '75%', description: 'Sweet berry flavor, smooth texture.', price: '$40/gram', isFeatured: false, isSoldOut: false, isLowStock: false, isOnSale: false, staffNotes: '' },
            ],
            'Cartridges': [
                { id: 'seed6', name: 'Strawberry Banana', brand: 'Vape King', type: 'Hybrid', format_type: 'Distillate', volume: '1g', device_type: '510 Screw On', potency: '85%', price: '$55', isFeatured: true, isSoldOut: false, isLowStock: false, isOnSale: true, staffNotes: 'Sale item.' },
                { id: 'seed7_cart', name: 'Pineapple Express Live Resin', brand: 'Resin Pens', type: 'Sativa', format_type: 'Live Resin', volume: '0.5g', device_type: 'All-In-One', potency: '90%', price: '$35', isFeatured: false, isSoldOut: false, isLowStock: false, isOnSale: false, staffNotes: '' }, 
            ],
            'Edibles': [
                { id: 'seed8', name: 'Blueberry Gummies', brand: 'Chew Factory', type: 'Hybrid', cannabinoids: 'CBD', dosage: '100mg', flavor: 'Blueberry', price: '$22', isFeatured: false, isSoldOut: false, isLowStock: false, isOnSale: false, staffNotes: '' },
                { id: 'seed9_edible', name: 'Sativa Fruit Chews', brand: 'Gummy Goodness', type: 'Sativa', cannabinoids: 'CBG', dosage: '50mg', flavor: 'Mango', price: '$18', isFeatured: false, isSoldOut: false, isLowStock: false, isOnSale: false, staffNotes: '' }, 
            ],
            'Topicals': [
                { id: 'seed9', name: 'CBD Relief Balm', brand: 'Wellness Co.', form: 'Balm', size: '4oz', cbd_ratio: '1:0 (1000mg CBD)', price: '$45', isFeatured: false, isSoldOut: false, isLowStock: false, isOnSale: false, staffNotes: '' },
            ],
            'Tinctures': [
                { id: 'seed10', name: 'Sleep Formula Drops', brand: 'Herbal Solutions', ratio: '1:1', potency: '500mg', size: '30ml', price: '$35', isFeatured: false, isSoldOut: false, isLowStock: false, isOnSale: false, staffNotes: '' },
            ],
            'Pre-Rolls': [
                 { id: 'seed11', name: 'Wedding Cake Single', type: 'Hybrid', weight: '1g', packaging: 'Singles', infused: 'No', potency: '28% THC', price: '$12', isFeatured: true, isSoldOut: false, isLowStock: false, isOnSale: false, staffNotes: '' },
            ],
            'Specials': [
                { id: 'seed13_manual', name: 'BOGO Tuesday Deal', category_target: 'All Products', description: 'Buy one, get one 50% off on all accessories.', price: 'Varies', isFeatured: false, isSoldOut: false, isLowStock: false, isOnSale: true, staffNotes: 'Auto-apply at register' },
            ]
        };

        // Helper to get the correct public collection path
        function getCollectionPath(category) {
            // Uses the globally set 'appId' which is determined by the canvas env or fallback
            return `artifacts/${appId}/public/data/${category}`;
        }

        // --- Core Utility Functions (Needed early) ---

        // Simple message display instead of alert
        function showMessage(text, isError = false) {
            let messageBox = document.getElementById('message-box');
            if (!messageBox) return; 
            
            messageBox.style.backgroundColor = isError ? '#dc2626' : '#22352F';
            messageBox.textContent = text;
            messageBox.classList.remove('hidden', 'opacity-0');
            messageBox.classList.add('opacity-100');

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, 3000);
        }
        
        // Function to extract price for sorting
        function extractPrice(priceStr) {
            const match = priceStr ? String(priceStr).match(/(\d+\.?\d*)/) : null;
            return match ? parseFloat(match[1]) : (currentSortDirection === 'asc' ? Infinity : -Infinity);
        }

        // --- Firebase Data and CRUD Operations ---

        async function seedCollection(category) {
            if (!window.db || !seedData[category] || Object.keys(inventory[category]).length > 0) return;
            const batch = window.writeBatch(window.db);
            const path = getCollectionPath(category);
            const itemsToSeed = seedData[category];

            itemsToSeed.forEach(item => {
                const docRef = window.doc(window.db, path, item.id);
                batch.set(docRef, { ...item, category: category }); 
            });

            try {
                await batch.commit();
                console.log(`Seeded ${category} collection.`);
            } catch (e) {
                console.error(`Seeding ${category} failed:`, e);
            }
        }

        function setupDataListeners() {
            allCategories.forEach(category => {
                const path = getCollectionPath(category);
                const q = window.query(window.collection(window.db, path));
                
                window.onSnapshot(q, (snapshot) => {
                    const itemsMap = {};
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        itemsMap[doc.id] = { 
                            id: doc.id, 
                            ...data, 
                            category: category,
                            isFeatured: !!data.isFeatured,
                            isSoldOut: data.isSoldOut !== undefined ? !!data.isSoldOut : false,
                            isLowStock: data.isLowStock !== undefined ? !!data.isLowStock : false,
                            isOnSale: data.isOnSale !== undefined ? !!data.isOnSale : false 
                        };
                    });
                    inventory[category] = itemsMap;
                    
                    if (snapshot.empty && seedData[category]) {
                        seedCollection(category); 
                    }
                    
                    renderMenu();
                    
                    const loadingIndicator = document.getElementById('loading-indicator');
                    if (loadingIndicator) {
                        loadingIndicator.classList.add('hidden');
                    }
                }, (error) => {
                    console.error(`Error listening to Firestore for ${category}:`, error);
                    const loadingIndicator = document.getElementById('loading-indicator');
                    if (loadingIndicator) {
                        loadingIndicator.textContent = `Error loading menu. Please refresh.`;
                        loadingIndicator.classList.add('text-red_sale');
                    }
                });
            });
        }
        
        // --- ADMIN CRUD FUNCTIONS ---
        
        async function saveItem() {
            const form = document.getElementById('admin-form');
            const itemId = document.getElementById('edit-item-id').value;
            const isNewItem = !itemId;
            const docId = isNewItem ? crypto.randomUUID() : itemId; 
            // *** FIX: Get category from the form, not global state ***
            // We need to know which category to save to. We'll use the currentCategory
            // which is set *before* the modal is opened.
            const path = getCollectionPath(currentCategory);
            
            let itemData = { category: currentCategory };
            let isValid = true;
            
            // Collect data from dynamic fields
            const fields = categoryFields[currentCategory];
            fields.forEach(field => {
                const input = document.getElementById(`field-${field.id}`);
                if (input) {
                    const value = input.value;
                    if (field.required && !value) {
                        isValid = false;
                        input.classList.add('border-red_sale');
                        showMessage(`Field "${field.label}" is required.`, true);
                    } else {
                        input.classList.remove('border-red_sale');
                        itemData[field.id] = value;
                    }
                }
            });
            
            if (!isValid) return;

            // Collect admin status data
            itemData.isFeatured = document.getElementById('isFeatured').checked;
            itemData.isOnSale = document.getElementById('isOnSale').checked;
            itemData.isLowStock = document.getElementById('isLowStock').checked;
            itemData.isSoldOut = document.getElementById('isSoldOut').checked;
            itemData.staffNotes = document.getElementById('staffNotes').value || '';
            
            try {
                const docRef = window.doc(window.db, path, docId);
                await window.setDoc(docRef, itemData);
                showMessage(isNewItem ? 'Item added successfully!' : 'Item updated successfully!');
                hideAdminModal();
            } catch (e) {
                console.error("Error saving item:", e);
                showMessage("Error: Could not save item.", true);
            }
        }

        async function handleDeleteItem(itemId, category) {
            // *** FIX: Use a custom modal instead of confirm() ***
            // We'll add this modal later, for now, let's keep the confirm
            // as the user's file has it.
            if (!confirm(`Are you sure you want to delete this item?\n\n${inventory[category][itemId].name}\n\nThis action cannot be undone.`)) {
                return;
            }
            
            const path = getCollectionPath(category);
            try {
                const docRef = window.doc(window.db, path, itemId);
                await window.deleteDoc(docRef);
                showMessage("Item deleted successfully.");
            } catch (e) {
                console.error("Error deleting item:", e);
                showMessage("Error: Could not delete item.", true);
            }
        }
        
        // --- UI/Modal Logic (Requires other functions defined) ---

        function hideItemDetailModal() { document.getElementById('item-detail-modal').style.display = 'none'; };
        function hideAdminModal() { document.getElementById('admin-modal').style.display = 'none'; };
        
        // *** NEW: Category Select Modal Functions ***
        function hideCategorySelectModal() { document.getElementById('category-select-modal').style.display = 'none'; };
        
        function showCategorySelectModal() {
            const modal = document.getElementById('category-select-modal');
            const buttonContainer = document.getElementById('category-select-buttons');
            
            // Build buttons for all "real" categories
            let buttonsHtml = '';
            // Filter out 'All Products' and 'Specials' from the list of choices
            const categoriesToAdd = allCategories.filter(cat => cat !== 'Specials');
            
            categoriesToAdd.forEach(cat => {
                buttonsHtml += `<button class="bg-sage text-cream p-3 rounded-lg font-bold hover:bg-forest transition btn-brand" onclick="selectCategoryForAdd('${cat}')">${cat}</button>`;
            });
            
            buttonContainer.innerHTML = buttonsHtml;
            modal.style.display = 'flex';
        }

        function selectCategoryForAdd(category) {
            // This function is called by the new modal's buttons
            hideCategorySelectModal();
            // Set the current category state
            currentCategory = category;
            // Update the UI to reflect this (optional, but good)
            renderCategories(); 
            // Now, open the admin modal for a new item in this chosen category
            openAdminModal(null);
        }

        function showItemDetailModal(itemId) {
            if (isAdmin) return; // Admins shouldn't see customer modal, they use edit
            
            let item = null;
            for (const cat of allCategories) {
                if (inventory[cat] && inventory[cat][itemId]) { item = inventory[cat][itemId]; break; }
            }

            if (!item) { showMessage("Error: Product details not found.", true); return; }

            // Prevent opening detail for sold out items
            if (item.isSoldOut) return;

            const modalTitle = document.getElementById('detail-modal-title');
            const modalBody = document.getElementById('detail-modal-body');
            
            modalTitle.textContent = item.name;
            
            let html = `<p class="text-sm font-semibold text-sage/90 mb-4">${item.category.toUpperCase()} | ${item.brand || item.grower || ''}</p>`;
            
            // Dynamic Price Display
            html += `<div class="p-4 bg-sage/10 rounded-lg space-y-2 border border-sage/20"><h4 class="text-lg font-bold text-forest">Pricing Options</h4>`;

            if (item.category === 'Flower') {
                if (item.price_1g) html += `<p class="flex justify-between font-medium"><span>1 gram:</span> <span class="text-xl font-bold ${item.isFeatured ? 'text-red_sale' : 'text-forest'}">${item.price_1g}</span></p>`;
                if (item.price_35g) html += `<p class="flex justify-between font-medium"><span>3.5 grams (Eighth):</span> <span class="text-lg font-semibold">${item.price_35g}</span></p>`;
                if (item.price_7g) html += `<p class="flex justify-between font-medium"><span>7 grams (Quarter):</span> <span class="text-lg font-semibold">${item.price_7g}</span></p>`;
            } else {
                 html += `<p class="flex justify-between font-medium"><span>Unit Price:</span> <span class="text-xl font-bold ${item.isFeatured ? 'text-red_sale' : 'text-forest'}">${item.price || 'N/A'}</span></p>`;
            }
            html += `</div>`;

            // Full Details
            html += `<div class="mt-6 space-y-3"><h4 class="text-lg font-bold text-forest border-b border-sage/30 pb-1">Product Details</h4>`;

            if (item.description) { html += `<p class="text-base">${item.description}</p>`; }

            // Filter out admin-only fields
            const detailFields = categoryFields[item.category].filter(f => !['name', 'description', 'price', 'price_1g', 'price_35g', 'price_7g', 'staffNotes'].includes(f.id));
            
            detailFields.forEach(field => {
                if (item[field.id]) {
                    html += `<p class="text-sm"><span class="font-semibold text-forest/80">${field.label.split('(')[0].trim()}:</span> ${item[field.id]}</p>`;
                }
            });
            html += `</div>`;
            
            // Staff notes (ADMIN ONLY - this is customer modal)
            if (isAdmin && item.staffNotes) {
                html += `<div class="mt-4 p-3 bg-red_sale/10 border border-red_sale rounded-lg">
                             <h5 class="font-bold text-red_sale">Staff Note:</h5>
                             <p class="text-sm text-forest">${item.staffNotes}</p>
                           </div>`;
            }

            document.getElementById('detail-modal-body').innerHTML = html;
            document.getElementById('item-detail-modal').style.display = 'flex';
        };

        // --- ADMIN MODAL (ADD/EDIT) ---
        function openAdminModal(item = null) {
            const isNewItem = !item;
            const modalTitle = document.getElementById('admin-modal-title');
            const formFields = document.getElementById('admin-form-fields');
            
            // *** FIX: This function now relies on `currentCategory` being set *before* it's called ***
            modalTitle.textContent = isNewItem ? `Add New ${currentCategory}` : `Edit ${item.name}`;
            
            document.getElementById('edit-item-id').value = isNewItem ? '' : item.id;
            
            let html = '';
            const fields = categoryFields[currentCategory];
            
            fields.forEach(field => {
                // Don't render the admin-only staffNotes in the main form loop
                if (field.adminOnly) return;

                const value = isNewItem ? '' : (item[field.id] || '');
                const required = field.required ? 'required' : '';
                
                html += `<div><label for="field-${field.id}" class="block text-sm font-bold text-forest mb-1">${field.label} ${field.required ? '<span class="text-red_sale">*</span>' : ''}</label>`;
                
                const commonClasses = "w-full p-2 border-2 border-sage/50 rounded-xl bg-white text-forest focus:outline-none focus:ring-2 focus:ring-sage font-serif";

                if (field.type === 'textarea') {
                    html += `<textarea id="field-${field.id}" rows="3" class="${commonClasses}" placeholder="${field.placeholder || ''}">${value}</textarea>`;
                } else if (field.type === 'select') {
                    html += `<select id="field-${field.id}" class="${commonClasses}" ${required}>`;
                    html += `<option value="">Select ${field.label}</option>`;
                    (field.options || []).forEach(opt => {
                        html += `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`;
                    });
                    html += `</select>`;
                } else { // text
                    html += `<input type="text" id="field-${field.id}" value="${value}" class="${commonClasses}" placeholder="${field.placeholder || ''}" ${required}>`;
                }
                html += `</div>`;
            });
            
            formFields.innerHTML = html;

            // Populate admin status fields
            document.getElementById('isFeatured').checked = isNewItem ? false : !!item.isFeatured;
            document.getElementById('isOnSale').checked = isNewItem ? false : !!item.isOnSale;
            document.getElementById('isLowStock').checked = isNewItem ? false : !!item.isLowStock;
            document.getElementById('isSoldOut').checked = isNewItem ? false : !!item.isSoldOut;
            document.getElementById('staffNotes').value = isNewItem ? '' : (item.staffNotes || '');

            document.getElementById('admin-modal').style.display = 'flex';
        }
        
        // *** FIX: This function's logic is now correct ***
        function handleAddItemClick() {
            if (currentCategory === 'All Products') {
                 // Show the new modal to select a category
                 showCategorySelectModal();
                 return;
            }
            // For 'Specials' or any other specific category, just open the modal
            openAdminModal(null); // Open modal for a new item in the currentCategory
        }

        function handleEditItem(itemId, category) {
            const item = inventory[category] ? inventory[category][itemId] : null;
            if (!item) {
                showMessage("Error: Could not find item to edit.", true);
                return;
            }
            
            // Ensure the modal opens for the correct category
            if (currentCategory !== category) {
                changeCategory(category);
            }
            
            // *** FIX: Set currentCategory before opening modal ***
            // This is crucial for the modal title and save function
            currentCategory = category;
            openAdminModal(item); // Open modal with item data
        }

        // *** FIX: This function's logic is now correct ***
        function changeCategory(category) {
            currentCategory = category;
            
            const supportsTypeFilter = ['All Products', 'Flower', 'Cartridges', 'Concentrates', 'Pre-Rolls', 'Edibles'].includes(category);
            if (!supportsTypeFilter) { currentTypeFilter = 'All'; }
            
            // Reset ALL specific filters when changing categories
            currentFormatFilter = 'All';
            currentDeviceFilter = 'All';
            currentVolumeFilter = 'All';
            currentRatioFilter = 'All';
            currentPackagingFilter = 'All';
            currentInfusionFilter = 'All';
            currentFormFilter = 'All';
            currentWeightFilter = 'All';
            currentCannabinoidFilter = 'All'; 

            // Update Add Item button label (ADMIN)
            const addBtnLabel = document.getElementById('add-item-category-label');
            if (addBtnLabel) {
                if (category === 'All Products') {
                     addBtnLabel.textContent = '...'; // New label for "All Products"
                } else {
                     addBtnLabel.textContent = category; // Correctly sets to "Specials", "Flower", etc.
                }
            }
            
            renderCategories();
            renderControls();
            renderMenu();
        };
        
        // --- Search, Filter & Sort Functions ---
        function handleSearch(event) { currentSearchQuery = event.target.value.toLowerCase().trim(); renderControls(); renderMenu(); };
        function handleTypeFilter(type) { currentTypeFilter = type; renderControls(); renderMenu(); };
        function handleFormatFilter(format) { currentFormatFilter = format; renderControls(); renderMenu(); };
        function handleDeviceFilter(device) { currentDeviceFilter = device; renderControls(); renderMenu(); };
        function handleVolumeFilter(volume) { currentVolumeFilter = volume; renderControls(); renderMenu(); };
        function handleRatioFilter(ratio) { currentRatioFilter = ratio; renderControls(); renderMenu(); };
        function handleFormFilter(form) { currentFormFilter = form; renderControls(); renderMenu(); }; 
        function handleWeightFilter(weight) { currentWeightFilter = weight; renderControls(); renderMenu(); };
        function handlePackagingFilter(packaging) { currentPackagingFilter = packaging; renderControls(); renderMenu(); };
        function handleInfusionFilter(infused) { currentInfusionFilter = infused; renderControls(); renderMenu(); };
        function handleCannabinoidFilter(cannabinoid) { currentCannabinoidFilter = cannabinoid; renderControls(); renderMenu(); }; 
        function handleSortChange(event) { currentSortBy = event.target.value; renderControls(); renderMenu(); };
        function handleSortDirection(direction) { currentSortDirection = direction; renderControls(); renderMenu(); };
        
        // --- RENDER CONTROLS ---
        
        function renderControls() {
            const controlsContainer = document.getElementById('controls-container');
            const searchPlaceholder = currentCategory === 'All Products' ? 'Search all products...' : `Search in ${currentCategory}...`;

            // Start of controls HTML
            let html = `<div class="mb-2"><input type="text" id="search-input" oninput="handleSearch(event)" value="${currentSearchQuery}" class="w-full p-2 border-2 border-sage rounded-xl bg-white text-forest focus:outline-none focus:ring-2 focus:ring-sage placeholder-sage/70 font-serif text-sm" placeholder="${searchPlaceholder}"></div>`;
            
            // --- Type Filter Bar (Indica/Sativa/Hybrid) ---
            const typeFilters = ['All Types', 'Indica', 'Sativa', 'Hybrid'];
            const supportsTypeFilter = ['All Products', 'Flower', 'Cartridges', 'Concentrates', 'Pre-Rolls', 'Edibles'].includes(currentCategory);

            if (supportsTypeFilter) {
                html += `<div class="mb-2 p-2 bg-cream shadow-inner rounded-xl border border-sage/30">
                             <label class="text-xs font-bold text-forest mb-1 block">Filter by Type:</label>
                             <div class="flex flex-wrap gap-2">`;
                
                typeFilters.forEach(type => {
                    const filterValue = type === 'All Types' ? 'All' : type;
                    const isActive = currentTypeFilter === filterValue;
                    const buttonClass = isActive ? 'bg-forest text-cream' : 'bg-white text-forest border border-sage/50 hover:bg-sage/10';
                    
                    html += `<button onclick="handleTypeFilter('${filterValue}')" class="p-1.5 px-3 rounded-lg transition text-xs font-semibold btn-brand ${buttonClass}">${type}</button>`;
                });
                html += `</div></div>`;
            }

            // --- Edibles Cannabinoid Filter Bar (CBD / CBC / CBG / CBN) ---
            if (currentCategory === 'Edibles') {
                const cannabinoidFilters = ['All Cannabinoids', 'THC', 'CBD', 'CBG', 'CBN', 'CBC'];
                 html += `<div class="mb-2 p-2 bg-cream shadow-inner rounded-xl border border-sage/30">
                                  <label class="text-xs font-bold text-forest mb-1 block">Filter by Cannabinoid Focus:</label>
                                  <div class="flex flex-wrap gap-2">`;
                
                cannabinoidFilters.forEach(cb => {
                    const filterValue = cb === 'All Cannabinoids' ? 'All' : cb;
                    const isActive = currentCannabinoidFilter === filterValue;
                    const buttonClass = isActive ? 'bg-forest text-cream' : 'bg-white text-forest border border-sage/50 hover:bg-sage/10';
                    
                    html += `<button onclick="handleCannabinoidFilter('${filterValue}')" class="p-1.5 px-3 rounded-lg transition text-xs font-semibold btn-brand ${buttonClass}">${cb}</button>`;
                });
                html += `</div></div>`;
             }

            // --- Concentrates Format Filter Bar (Live Rosin / Live Resin) ---
            if (currentCategory === 'Concentrates') {
                const formatFilters = ['All Formats', 'Live Resin', 'Live Rosin'];
                html += `<div class="mb-2 p-2 bg-cream shadow-inner rounded-xl border border-sage/30">
                             <label class="text-xs font-bold text-forest mb-1 block">Filter by Concentrate Format:</label>
                             <div class="flex flex-wrap gap-2">`;
                
                formatFilters.forEach(format => {
                    const filterValue = format === 'All Formats' ? 'All' : format;
                    const isActive = currentFormatFilter === filterValue;
                    const buttonClass = isActive ? 'bg-forest text-cream' : 'bg-white text-forest border border-sage/50 hover:bg-sage/10';
                    
                    html += `<button onclick="handleFormatFilter('${filterValue}')" class="p-1.5 px-3 rounded-lg transition text-xs font-semibold btn-brand ${buttonClass}">${format}</button>`;
                });
                html += `</div></div>`;
            }

            // --- Tinctures Ratio Filter Bar ---
             if (currentCategory === 'Tinctures') {
                const ratioFilters = ['All Ratios', '1:1', '5:1 CBD', 'CBD Only', 'THC Only'];
                html += `<div class="mb-2 p-2 bg-cream shadow-inner rounded-xl border border-sage/30">
                             <label class="text-xs font-bold text-forest mb-1 block">Filter by Cannabinoid Ratio:</label>
                             <div class="flex flex-wrap gap-2">`;
                
                ratioFilters.forEach(ratio => {
                    const filterValue = ratio === 'All Ratios' ? 'All' : ratio;
                    const isActive = currentRatioFilter === filterValue;
                    const buttonClass = isActive ? 'bg-forest text-cream' : 'bg-white text-forest border border-sage/50 hover:bg-sage/10';
                    
                    html += `<button onclick="handleRatioFilter('${filterValue}')" class="p-1.5 px-3 rounded-lg transition text-xs font-semibold btn-brand ${buttonClass}">${ratio}</button>`;
                });
                html += `</div></div>`;
            }

            // --- Topicals Form Filter Bar ---
             if (currentCategory === 'Topicals') {
                const formFilters = ['All Forms', 'Lotion', 'Balm', 'Salt', 'Oil'];
                html += `<div class="mb-2 p-2 bg-cream shadow-inner rounded-xl border border-sage/30">
                             <label class="text-xs font-bold text-forest mb-1 block">Filter by Product Form:</label>
                             <div class="flex flex-wrap gap-2">`;
                
                formFilters.forEach(form => {
                    const filterValue = form === 'All Forms' ? 'All' : form;
                    const isActive = currentFormFilter === filterValue;
                    const buttonClass = isActive ? 'bg-forest text-cream' : 'bg-white text-forest border border-sage/50 hover:bg-sage/10';
                    
                    html += `<button onclick="handleFormFilter('${filterValue}')" class="p-1.5 px-3 rounded-lg transition text-xs font-semibold btn-brand ${buttonClass}">${form}</button>`;
                });
                html += `</div></div>`;
            }

            // --- Cartridges Filters (Format, Size, Device) ---
            if (currentCategory === 'Cartridges') {
                // 1. Content/Format Filter (Live Rosin / Live Resin)
                const cartFormatFilters = ['All Contents', 'Live Rosin', 'Live Resin', 'Distillate', 'Oil'];
                html += `<div class="mb-2 p-2 bg-cream shadow-inner rounded-xl border border-sage/30">
                             <label class="text-xs font-bold text-forest mb-1 block">Filter by Content:</label>
                             <div class="flex flex-wrap gap-2">`;
                cartFormatFilters.forEach(format => {
                    const filterValue = format === 'All Contents' ? 'All' : format;
                    const isActive = currentFormatFilter === filterValue;
                    const buttonClass = isActive ? 'bg-forest text-cream' : 'bg-white text-forest border border-sage/50 hover:bg-sage/10';
                    html += `<button onclick="handleFormatFilter('${filterValue}')" class="p-1.5 px-3 rounded-lg transition text-xs font-semibold btn-brand ${buttonClass}">${format}</button>`;
                });
                html += `</div></div>`;
                
                // 2. Volume/Size Filter (0.5g / 1g / 2g)
                const volumeFilters = ['All Volumes', '0.5g', '1g', '2g'];
                html += `<div class="mb-2 p-2 bg-cream shadow-inner rounded-xl border border-sage/30">
                             <label class="text-xs font-bold text-forest mb-1 block">Filter by Volume:</label>
                             <div class="flex flex-wrap gap-2">`;
                volumeFilters.forEach(volume => {
                    const filterValue = volume === 'All Volumes' ? 'All' : volume;
                    const isActive = currentVolumeFilter === filterValue;
                    const buttonClass = isActive ? 'bg-forest text-cream' : 'bg-white text-forest border border-sage/50 hover:bg-sage/10';
                    html += `<button onclick="handleVolumeFilter('${filterValue}')" class="p-1.5 px-3 rounded-lg transition text-xs font-semibold btn-brand ${buttonClass}">${volume}</button>`;
                });
                html += `</div></div>`;

                // 3. Device Type Filter (510 / AIO)
                const deviceFilters = ['All Devices', '510 Screw On', 'All-In-One'];
                html += `<div class="mb-2 p-2 bg-cream shadow-inner rounded-xl border border-sage/30">
                             <label class="text-xs font-bold text-forest mb-1 block">Filter by Device Type:</label>
                             <div class="flex flex-wrap gap-2">`;
                deviceFilters.forEach(device => {
                    const filterValue = device === 'All Devices' ? 'All' : device;
                    const isActive = currentDeviceFilter === filterValue;
                    const buttonClass = isActive ? 'bg-forest text-cream' : 'bg-white text-forest border border-sage/50 hover:bg-sage/10';
                    html += `<button onclick="handleDeviceFilter('${filterValue}')" class="p-1.5 px-3 rounded-lg transition text-xs font-semibold btn-brand ${buttonClass}">${device}</button>`;
                });
                html += `</div></div>`;
            }

            // --- Pre-Rolls Filters (Weight, Packaging, Infusion) ---
            if (currentCategory === 'Pre-Rolls') {
                // 1. Weight Filter (0.5g / 1g / 1.5g)
                const weightFilters = ['All Weights', '0.5g', '1g', '1.5g'];
                html += `<div class="mb-2 p-2 bg-cream shadow-inner rounded-xl border border-sage/30">
                             <label class="text-xs font-bold text-forest mb-1 block">Filter by Weight:</label>
                             <div class="flex flex-wrap gap-2">`;
                weightFilters.forEach(weight => {
                    const filterValue = weight === 'All Weights' ? 'All' : weight;
                    const isActive = currentWeightFilter === filterValue;
                    const buttonClass = isActive ? 'bg-forest text-cream' : 'bg-white text-forest border border-sage/50 hover:bg-sage/10';
                    html += `<button onclick="handleWeightFilter('${filterValue}')" class="p-1.5 px-3 rounded-lg transition text-xs font-semibold btn-brand ${buttonClass}">${weight}</button>`;
                });
                html += `</div></div>`;
                
                // 2. Packaging/Infusion Filter (Packs / Singles / Infused)
                const packInfusionFilters = ['All Packaging', 'Singles', 'Packs', 'Infused', 'Non-Infused'];
                html += `<div class="mb-2 p-2 bg-cream shadow-inner rounded-xl border border-sage/30">
                             <label class="text-xs font-bold text-forest mb-1 block">Filter by Packaging/Infusion:</label>
                             <div class="flex flex-wrap gap-2">`;
                
                packInfusionFilters.forEach(filter => {
                    const filterValue = filter === 'All Packaging' ? 'All' : filter;
                    let isActive = false;
                    let handler = '';
                    
                    if (filter === 'Singles' || filter === 'Packs') {
                        isActive = currentPackagingFilter === filter;
                        handler = `currentPackagingFilter = '${filterValue}'; currentInfusionFilter = 'All'`;
                    } else if (filter === 'Infused') {
                        isActive = currentInfusionFilter === 'Yes';
                        handler = `currentInfusionFilter = 'Yes'; currentPackagingFilter = 'All'`;
                    } else if (filter === 'Non-Infused') {
                         isActive = currentInfusionFilter === 'No';
                         handler = `currentInfusionFilter = 'No'; currentPackagingFilter = 'All'`;
                    } else { // All Packaging
                        isActive = currentPackagingFilter === 'All' && currentInfusionFilter === 'All';
                        handler = `currentPackagingFilter = 'All'; currentInfusionFilter = 'All'`; 
                    }
                    
                    const buttonClass = isActive ? 'bg-forest text-cream' : 'bg-white text-forest border border-sage/50 hover:bg-sage/10';
                    
                    html += `<button onclick="${handler}; renderControls(); renderMenu();" class="p-1.5 px-3 rounded-lg transition text-xs font-semibold btn-brand ${buttonClass}">${filter}</button>`;
                });
                html += `</div></div>`;
            }


            // --- Sort Controls ---
            let sortOptions = [{ value: 'name', label: 'Name' }];
            const fields = categoryFields[currentCategory] || [];
            
            fields.forEach(f => {
                if(f.sortable && f.id !== 'name') {
                    // FIX: If Flower, add only one consolidated Price option
                    if (currentCategory === 'Flower' && f.id.startsWith('price_')) {
                        if (f.id === 'price_1g') {
                            sortOptions.push({ value: 'price_1g', label: 'Price (1g Base)' });
                        }
                        return;
                    } 
                    sortOptions.push({ value: f.id, label: f.label.split('(')[0].trim() });
                }
            });
            
            // Consolidate All Products Sort Options
            if (currentCategory === 'All Products' || currentCategory === 'Specials') {
                 sortOptions = [{ value: 'name', label: 'Name' }, { value: 'price', label: 'Price (Default)' }, { value: 'type', label: 'Type' }];
                 if(!['name', 'price', 'type'].includes(currentSortBy)) { currentSortBy = 'name'; }
            } else if (currentCategory !== 'Flower') {
                 sortOptions = sortOptions.filter(opt => !opt.value.startsWith('price_'));
                 if (!sortOptions.some(opt => opt.value === 'price')) {
                   sortOptions.push({ value: 'price', label: 'Price' });
                 }
            }


            html += `
                <div class="flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0 sm:space-x-4 mb-2 p-2 bg-cream shadow-inner rounded-xl border border-sage/30">
                    <div class="flex items-center space-x-2 w-full sm:w-auto">
                        <label for="sort-by" class="text-xs font-bold text-forest whitespace-nowrap">Sort By:</label>
                        <select id="sort-by" onchange="handleSortChange(event)" class="p-1.5 border border-sage/50 rounded-lg bg-white text-forest text-xs w-full font-serif">
            `;
            sortOptions.forEach(opt => { html += `<option value="${opt.value}" ${currentSortBy === opt.value ? 'selected' : ''}>${opt.label}</option>`; });

            html += `</select></div><div class="flex space-x-2 w-full sm:w-auto justify-end">
                        <button class="flex items-center space-x-1 p-1.5 rounded-lg text-xs transition btn-brand w-1/2 sm:w-auto ${currentSortDirection === 'asc' ? 'bg-forest text-cream' : 'bg-gray-200 text-forest hover:bg-gray-300'}" onclick="handleSortDirection('asc')" title="Sort Ascending">A-Z / Low <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg></button>
                        <button class="flex items-center space-x-1 p-1.5 rounded-lg text-xs transition btn-brand w-1/2 sm:w-auto ${currentSortDirection === 'desc' ? 'bg-forest text-cream' : 'bg-gray-200 text-forest hover:bg-gray-300'}" onclick="handleSortDirection('desc')" title="Sort Descending">Z-A / High <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg></button>
                    </div>
                </div>
            `;
            
            controlsContainer.innerHTML = html;
            if (document.getElementById('search-input')) { document.getElementById('search-input').value = currentSearchQuery; }
            if (document.getElementById('sort-by')) { document.getElementById('sort-by').value = currentSortBy; }
        }
        
        function renderCategories() {
            const tabsContainer = document.getElementById('category-tabs');
            tabsContainer.innerHTML = '';
            navCategories.forEach(category => {
                const isActive = currentCategory === category;
                const button = document.createElement('button');
                button.onclick = () => window.changeCategory(category);
                const iconHtml = categoryIcons[category] || '';
                const activeClasses = 'bg-sage text-cream border-b-4 border-cream';
                const inactiveClasses = 'text-cream/70 hover:text-cream/90 hover:bg-forest/70 transition';
                // FIX: Added flex-grow and flex-shrink to distribute width evenly
                button.innerHTML = `<span class="flex justify-center items-center space-x-1 sm:space-x-2">${iconHtml}<span>${category}</span></span>`;
                button.className = `p-3 sm:p-4 flex-grow flex-shrink-0 text-xs sm:text-base font-bold ${isActive ? activeClasses : inactiveClasses} whitespace-nowrap`;
                tabsContainer.appendChild(button);
            });
        }
        
        function renderMenu() {
            const productList = document.getElementById('product-list');
            let itemsToDisplay = [];
            
            if (currentCategory === 'All Products') {
                for (const cat in inventory) { for (const id in inventory[cat]) { itemsToDisplay.push(inventory[cat][id]); } }
            } else if (currentCategory === 'Specials') {
                 itemsToDisplay = [];
                 for (const cat in inventory) {
                     for (const id in inventory[cat]) {
                         const item = inventory[cat][id];
                         if ((cat === 'Specials' && !item.isSoldOut) || 
                             ((item.isFeatured || item.isOnSale) && item.category !== 'Specials' && !item.isSoldOut) ) {
                             itemsToDisplay.push(item);
                         }
                     }
                 }
                 itemsToDisplay = itemsToDisplay.filter((value, index, self) =>
                    index === self.findIndex((t) => (t.id === value.id && t.category === value.category))
                 );
            } else if (inventory[currentCategory]) {
                itemsToDisplay = Object.values(inventory[currentCategory]);
            }

            if (currentSearchQuery.length > 0) {
                itemsToDisplay = itemsToDisplay.filter(item => Object.values(item).some(value => 
                    typeof value === 'string' && value.toLowerCase().includes(currentSearchQuery)));
            }
            
            // --- FILTERING LOGIC ---
            
            // 1. Type Filter (Universal for Flower, Concentrates, Cartridges, Pre-Rolls, Edibles)
            if (currentTypeFilter !== 'All') {
                itemsToDisplay = itemsToDisplay.filter(item => item.type && item.type === currentTypeFilter);
            }
            
            // 2. Concentrates Format Filter (Live Resin / Live Rosin)
            if (currentCategory === 'Concentrates' && currentFormatFilter !== 'All') {
                itemsToDisplay = itemsToDisplay.filter(item => item.format && item.format === currentFormatFilter);
            }
            
            // 3. Topicals Form Filter (Lotions / Balms / Salts / Oils)
            if (currentCategory === 'Topicals' && currentFormFilter !== 'All') {
                 itemsToDisplay = itemsToDisplay.filter(item => item.form && item.form === currentFormFilter);
            }

            // 4. Tinctures Ratio Filter
            if (currentCategory === 'Tinctures' && currentRatioFilter !== 'All') {
                 itemsToDisplay = itemsToDisplay.filter(item => item.ratio && item.ratio === currentRatioFilter);
            }

            // 5. Edibles Cannabinoid Filter (NEW)
            if (currentCategory === 'Edibles' && currentCannabinoidFilter !== 'All') {
                 itemsToDisplay = itemsToDisplay.filter(item => item.cannabinoids && item.cannabinoids.includes(currentCannabinoidFilter));
            }
            
            // Cartridges Filters
            if (currentCategory === 'Cartridges') {
                if (currentFormatFilter !== 'All') { itemsToDisplay = itemsToDisplay.filter(item => item.format_type && item.format_type === currentFormatFilter); }
                if (currentDeviceFilter !== 'All') { itemsToDisplay = itemsToDisplay.filter(item => item.device_type && item.device_type === currentDeviceFilter); }
                if (currentVolumeFilter !== 'All') { itemsToDisplay = itemsToDisplay.filter(item => item.volume && item.volume === currentVolumeFilter); }
            }

            // Pre-Rolls Filters
            if (currentCategory === 'Pre-Rolls') {
                if (currentWeightFilter !== 'All') { itemsToDisplay = itemsToDisplay.filter(item => item.weight && item.weight === currentWeightFilter); }
                if (currentPackagingFilter !== 'All') { itemsToDisplay = itemsToDisplay.filter(item => item.packaging && item.packaging === currentPackagingFilter); }
                if (currentInfusionFilter !== 'All') { itemsToDisplay = itemsToDisplay.filter(item => item.infused && item.infused === currentInfusionFilter); }
            }

            // --- END FILTERING LOGIC ---
            
            // Sorting Logic
            itemsToDisplay.sort((a, b) => {
                const featuredCompare = (b.isFeatured ? 1 : 0) - (a.isFeatured ? 1 : 0);
                if (featuredCompare !== 0) return featuredCompare;
                const soldOutCompare = (a.isSoldOut ? 1 : 0) - (b.isSoldOut ? 1 : 0);
                if (soldOutCompare !== 0) return soldOutCompare;

                let aValue = a[currentSortBy] || '';
                let bValue = b[currentSortBy] || '';
                let comparison = 0;
                
                let sortKey = currentSortBy;
                
                const priceFields = ['price_1g', 'price_35g', 'price_7g', 'price'];
                if (priceFields.includes(sortKey) || ((currentCategory === 'All Products' || currentCategory === 'Specials') && currentSortBy === 'price')) {
                    
                    if ((currentCategory === 'All Products' || currentCategory === 'Specials') && currentSortBy === 'price') {
                        aValue = a.price_1g || a.price; // Use 1g price as base in All Products
                        bValue = b.price_1g || b.price;
                    } else if (currentCategory === 'Flower' && currentSortBy === 'price_1g') { // Specific Flower Price Sort Fix
                        aValue = a.price_1g;
                        bValue = b.price_1g;
                    }
                    
                    const numericA = extractPrice(aValue);
                    const numericB = extractPrice(bValue);
                    comparison = numericA - numericB;

                } else {
                    comparison = String(aValue).localeCompare(String(bValue), undefined, { numeric: true });
                }
                
                return currentSortDirection === 'asc' ? comparison : -comparison;
            });

            // Render HTML
            if (itemsToDisplay.length === 0) {
                let message = `No items available in the ${currentCategory} category.`;
                if (currentCategory === 'Specials') { message = `No specials are currently active.`; }
                else if (currentSearchQuery.length > 0) { message = `No products found matching "${currentSearchQuery}".`; } 
                else if (currentTypeFilter !== 'All') { message = `No ${currentTypeFilter} products found in this category.`; }
                // Add specific filter error messages if needed here
                productList.innerHTML = `<div class="col-span-full text-center text-xl text-sage pt-10 font-serif">${message}</div>`;
            } else {
                productList.innerHTML = itemsToDisplay.map(renderProductCard).join('');
            }
        }
        
        // Final function definitions and Initialization logic
        
        function renderProductCard(item) {
            const isFlower = item.category === 'Flower';
            const priceColorClass = item.isFeatured ? 'text-red_sale' : 'text-forest';

            let priceHtml = '';

            if (isFlower) {
                // Flower: Display 1g and 3.5g price side-by-side
                priceHtml = `
                    <div class="flex flex-col space-y-1">
                        <span class="text-xl font-bold ${priceColorClass}">${item.price_1g || 'N/A'}</span>
                        <span class="text-xs text-sage/90">${item.price_35g || 'N/A'} / 3.5g</span>
                    </div>
                `;
            } else {
                // Other: Display unit price
                priceHtml = `<span class="text-xl font-bold ${priceColorClass}">${item.price || 'N/A'}</span>`;
            }
            
            const soldOutBadge = item.isSoldOut ? `<div class="absolute inset-0 bg-forest/80 flex items-center justify-center rounded-xl pointer-events-none z-10"><span class="text-xl md:text-2xl font-bold text-cream bg-red_sale/90 p-2 md:p-3 shadow-2xl transform -rotate-6 rounded-xl whitespace-nowrap">SOLD OUT</span></div>` : '';
            const featuredBanner = item.isFeatured ? `<div class="bg-red_sale text-cream text-center text-xs font-bold py-1 uppercase tracking-wider">‚≠ê FEATURED PRODUCT</div>` : '';
            
            // NEW: Low Stock and Sale Badges (Priority: Sale > Low Stock)
            let topRightBadges = '';
            let badges = [];

            // Low Stock Badge
            if (item.isLowStock && !item.isSoldOut && !item.isFeatured) {
                 badges.push(`<span class="bg-orange_low text-white text-xs font-bold px-2 py-1 rounded-full shadow-md">LOW STOCK</span>`);
            }
            // On Sale Badge
            if (item.isOnSale && !item.isSoldOut && !item.isFeatured) {
                 badges.push(`<span class="bg-sale_blue text-white text-xs font-bold px-2 py-1 rounded-full shadow-md">ON SALE</span>`);
            }
            
            if (badges.length > 0) {
                 topRightBadges = `<div class="flex space-x-1 absolute top-2 right-2 z-5">${badges.join('')}</div>`;
            }

            
            // ADMIN: Add Edit/Delete buttons
            let adminButtons = '';
            if (isAdmin) {
                adminButtons = `
                    <div class="p-2 bg-forest/10 flex justify-end space-x-2">
                        <button class="bg-forest text-cream p-2 rounded-lg text-xs font-bold btn-brand" onclick="event.stopPropagation(); handleEditItem('${item.id}', '${item.category}')">Edit</button>
                        <button class="bg-red_sale text-white p-2 rounded-lg text-xs font-bold btn-brand" onclick="event.stopPropagation(); handleDeleteItem('${item.id}', '${item.category}')">Delete</button>
                    </div>
                `;
            }

            
            const cardClasses = `relative flex flex-col bg-white rounded-xl shadow-lg transition-transform duration-300 ${isAdmin ? 'hover:scale-[1.02]' : 'hover:scale-[1.03]'} overflow-hidden border border-sage/30 ${item.isSoldOut ? 'sold-out' : (isAdmin ? '' : 'cursor-pointer')}`;
            // ADMIN: Change click handler based on admin status
            const clickHandler = isAdmin ? '' : `onclick="showItemDetailModal('${item.id}')"`;
            
            let cardHtml = `
                <div class="${cardClasses}" ${clickHandler}>
                    ${soldOutBadge}
                    ${featuredBanner}
                    ${topRightBadges}
                    
                    <div class="p-4 pt-3 flex flex-col justify-start flex-grow">
                        ${(currentCategory === 'All Products' || currentCategory === 'Specials') && !item.isFeatured ? `<span class="text-xs font-bold text-sage block mb-1">${item.category.toUpperCase()}</span>` : ''}
                        ${(currentCategory === 'All Products' || currentCategory === 'Specials') && item.isFeatured ? `<span class="text-xs font-bold text-sage block mt-6 mb-1">${item.category.toUpperCase()}</span>` : ''}
                        ${(currentCategory === 'All Products' || currentCategory === 'Specials') && (item.isLowStock || item.isOnSale) && !item.isFeatured ? `<span class="text-xs font-bold text-sage block mt-6 mb-1">${item.category.toUpperCase()}</span>` : ''}


                        <h2 class="text-xl font-bold text-forest mb-1 truncate" title="${item.name}">${item.name}</h2>
                        <p class="text-sage text-xs mb-2"><span class="font-semibold">${item.brand || item.grower || ''}</span> ${item.type ? `| ${item.type}` : ''}</p>
                        <p class="text-forest/80 text-sm line-clamp-2">${item.description || 'No description available.'}</p>
                    </div>

                    <div class="p-4 pt-3 border-t border-sage/20 mt-auto flex justify-between items-center bg-cream/70">
                        <div class="text-forest">${priceHtml}</div>
                    </div>
                    
                    <!-- ADMIN BUTTONS RENDERED HERE -->
                    ${adminButtons}
                </div>`;
            
            return cardHtml;
        }

        // --- ADMIN AUTHENTICATION ---
        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorP = document.getElementById('login-error');
            errorP.textContent = '';
            
            // --- FIX START ---
            // Add a guard clause to check if Firebase auth was initialized
            if (!window.auth) {
                console.error("Login Error: window.auth is not initialized. Check firebaseConfig.");
                errorP.textContent = 'Error: Firebase config is missing or invalid.';
                return;
            }
            // --- FIX END ---
            
            window.signInWithEmailAndPassword(window.auth, email, password)
                .then((userCredential) => {
                    // Success, handled by onAuthStateChanged
                })
                .catch((error) => {
                    console.error("Login Error:", error);
                    errorP.textContent = 'Login Failed. Check username or password.';
                });
        }
        
        function handleLogout() {
            window.signOut(window.auth).catch((error) => {
                console.error("Logout Error:", error);
                showMessage("Error logging out.", true);
            });
        }

        function toggleAdminUI(isLoggedIn) {
            isAdmin = isLoggedIn;
            const adminElements = document.querySelectorAll('.admin-controls');
            const loginModal = document.getElementById('login-modal');
            const loadingIndicator = document.getElementById('loading-indicator');
            
            if (isLoggedIn) {
                adminElements.forEach(el => el.style.display = 'block'); // Show admin controls
                if (loginModal) loginModal.style.display = 'none'; // Hide login modal
                if (loadingIndicator) loadingIndicator.textContent = 'Loading menu data...';
            } else {
                adminElements.forEach(el => el.style.display = 'none'); // Hide admin controls
                if (loginModal) loginModal.style.display = 'flex'; // Show login modal
                if (loadingIndicator) loadingIndicator.textContent = 'Please log in.';
            }
            // Re-render the menu to show/hide admin buttons on cards
            renderMenu();
        }

        function initMenu(isMock = false) {
             if (isMock) {
                allCategories.forEach(cat => {
                    inventory[cat] = {};
                    (seedData[cat] || []).forEach(item => {
                        const itemId = item.id || crypto.randomUUID(); 
                        inventory[cat][itemId] = { ...item, id: itemId, category: cat, isFeatured: item.isFeatured || false, isSoldOut: item.isSoldOut !== undefined ? item.isSoldOut : false, isLowStock: item.isLowStock || false, isOnSale: item.isOnSale || false };
                    });
                });
                renderCategories();
                renderControls();
                renderMenu();
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) {
                     loadingIndicator.textContent = 'Menu loaded (Mock Data)';
                     setTimeout(() => loadingIndicator.classList.add('hidden'), 500);
                }
                return;
             }
            
            renderCategories();
            renderControls();
            setupDataListeners();
        };

        // --- NEW: App Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Make core functions globally accessible for HTML onclicks
            window.hideItemDetailModal = hideItemDetailModal;
            window.hideAdminModal = hideAdminModal;
            // *** NEW: Add category modal functions to global scope ***
            window.hideCategorySelectModal = hideCategorySelectModal;
            window.showCategorySelectModal = showCategorySelectModal;
            window.selectCategoryForAdd = selectCategoryForAdd;
            // *** END NEW ***
            window.saveItem = saveItem;
            window.handleAddItemClick = handleAddItemClick;
            window.handleEditItem = handleEditItem;
            window.handleDeleteItem = handleDeleteItem;
            window.handleLogout = handleLogout;
            window.changeCategory = changeCategory;
            window.handleSearch = handleSearch;
            window.handleTypeFilter = handleTypeFilter;
            window.handleFormatFilter = handleFormatFilter;
            window.handleDeviceFilter = handleDeviceFilter;
            window.handleVolumeFilter = handleVolumeFilter;
            window.handleRatioFilter = handleRatioFilter;
            window.handleFormFilter = handleFormFilter;
            window.handleWeightFilter = handleWeightFilter;
            window.handlePackagingFilter = handlePackagingFilter;
            window.handleInfusionFilter = handleInfusionFilter;
            window.handleCannabinoidFilter = handleCannabinoidFilter;
            window.handleSortChange = handleSortChange;
            window.handleSortDirection = handleSortDirection;
            window.showItemDetailModal = showItemDetailModal;
            window.initMenu = initMenu;
            window.showMessage = showMessage;
            
            // Set up login form listener
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }

             // 1. Initialize Firebase
            if (Object.keys(firebaseConfig).length > 0 && !firebaseConfig.apiKey.includes("YOUR_")) {
                try {
                    const app = window.initializeApp(firebaseConfig);
                    window.db = window.getFirestore(app);
                    window.auth = window.getAuth(app);
                } catch (e) {
                    console.error("Firebase initialization failed:", e);
                }
            }

            // 2. Set up Auth Listener (The new core of the app)
            if (window.auth) {
                // --- CANVAS PREVIEW LOGIC ---
                // Try to sign in with a canvas token if it exists
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        console.log("Attempting sign-in with canvas token...");
                        await window.signInWithCustomToken(window.auth, __initial_auth_token);
                    } catch (e) {
                        console.error("Canvas token sign-in failed:", e);
                    }
                }

                window.onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        // User is signed in
                        window.userId = user.uid;
                        toggleAdminUI(true);
                        initMenu(false); // Initialize real data
                    } else {
                        // User is signed out
                        window.userId = null;
                        toggleAdminUI(false);
                        // Do NOT initMenu() here, force login
                    }
                });
            } else {
                console.warn("Firebase not initialized. Check config.");
                // We can't run admin in mock mode, show error
                const loadingIndicator = document.getElementById('loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.textContent = 'Firebase Config Missing. Cannot load admin panel.';
                    // This is a safe way to show the error without crashing
                    const errorBox = document.createElement('div');
                    errorBox.className = "p-4 bg-red-100 border-red-400 text-red-700 rounded-lg max-w-md mx-auto mt-10 font-serif";
                    errorBox.innerHTML = `<h4 class="font-bold">Firebase Error</h4><p>The <code>firebaseConfig</code> object is missing or invalid. Please add your keys (around line 400) to connect to the database.</p>`;
                    document.body.prepend(errorBox);
                    const loginModal = document.getElementById('login-modal');
                    if (loginModal) loginModal.style.display = 'none'; // Hide login
                }
                // initMenu(true); // Don't run mock mode for admin
            }
        });

    </script>
</body>
</html>
